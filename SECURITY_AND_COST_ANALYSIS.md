# セキュリティ脆弱性分析 & ランニングコスト概算

## 🔒 セキュリティ脆弱性分析

### ⚠️ 重大な問題

#### 1. **APIキーの露出（要確認）**
**現状**: `SUPABASE_KEY`がクライアント側のJavaScriptに直接記述されている
```javascript
const SUPABASE_KEY = 'sb_publishable_J5lxwjP27PycJD78Jkgzsw_VhW4ThgJ';
```

**評価**: 
- ✅ **問題なし**: これはSupabaseの`anon`（公開）キーで、クライアント側に露出しても問題ない設計
- ⚠️ **注意**: もし`service_role`キーが露出していたら重大な問題だが、現在は公開キーのみ

**推奨対策**:
- 環境変数や設定ファイルに分離（GitHubにコミットしない）
- 定期的にキーをローテーション

#### 2. **認証チェックの不備**
**現状**: 管理画面の認証はSupabase Authを使用しているが、一部の操作で認証チェックが不十分な可能性

**確認事項**:
- ✅ 管理画面: `db.auth.getSession()`でセッションチェック済み
- ✅ 予約作成: `user_id`でユーザー識別
- ⚠️ **要確認**: RLS（Row Level Security）がSupabase側で設定されているか

**推奨対策**:
```sql
-- SupabaseでRLSを有効化
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- ユーザーは自分の予約のみ閲覧可能
CREATE POLICY "Users can view own bookings"
ON bookings FOR SELECT
USING (auth.uid()::text = user_id);

-- 管理者は全予約を閲覧可能（要実装）
```

#### 3. **入力値検証の不足**
**現状**: 一部の入力値で検証が不十分

**問題箇所**:
- 電話番号の形式チェックなし
- 名前の長さ制限なし
- 料金の範囲チェックなし

**推奨対策**:
```javascript
// 電話番号の検証例
function validatePhone(phone) {
  const phoneRegex = /^[0-9\-+()]+$/;
  return phoneRegex.test(phone) && phone.length <= 20;
}

// 名前の検証例
function validateName(name) {
  return name.length >= 1 && name.length <= 50;
}
```

### ⚠️ 中程度の問題

#### 4. **XSS（Cross-Site Scripting）対策**
**現状**: `innerHTML`を使用している箇所でXSSのリスク

**問題箇所**:
- `staffListContainer.innerHTML` - スタッフ名を直接挿入
- 検索結果の表示

**推奨対策**:
```javascript
// textContentを使用、またはエスケープ処理
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

#### 5. **レート制限の不足**
**現状**: クライアント側でのレート制限なし

**リスク**: 
- 予約作成の連続リクエスト
- データ取得の過剰リクエスト

**推奨対策**:
- Supabase側でレート制限を設定
- クライアント側でデバウンス処理（一部実装済み）

#### 6. **キャッシュのセキュリティ**
**現状**: ローカルストレージに予約データをキャッシュ

**リスク**: 
- 個人情報がローカルストレージに残る可能性
- 共有PCでの情報漏洩

**推奨対策**:
- キャッシュに個人情報を含めない（現在は実装済み）
- セッション終了時にキャッシュをクリア

### ✅ 良好な点

1. **認証システム**: Supabase Authを使用
2. **HTTPS通信**: 全通信がHTTPS
3. **SQLインジェクション対策**: Supabaseが自動で対応
4. **キャッシュ最適化**: 個人情報を含まない設計

---

## 💰 ランニングコスト概算（1年あたり）

### 現在の構成

1. **Supabase** (データベース・認証)
2. **GitHub Pages** (ホスティング)
3. **LINE LIFF** (LINE連携)

### コスト内訳

#### 1. Supabase

**無料プラン（Free Tier）**:
- API Requests: 50,000回/月
- Database Size: 500MB
- Bandwidth: 5GB/月
- File Storage: 1GB

**使用量の想定**:
- 予約作成: 100件/月 × 3回（作成、確認、キャンセル） = 300リクエスト
- データ取得: 1,000回/月（日付変更、検索など）
- 管理画面: 500回/月
- **合計: 約1,800リクエスト/月**

**評価**: 
- ✅ **無料プランで十分**: 月間50,000リクエスト以内
- **年間コスト: ¥0**

**有料プランが必要になる場合**:
- Proプラン: $25/月（約¥3,750/月）
- **年間コスト: 約¥45,000**

#### 2. GitHub Pages

**無料プラン**:
- 公開リポジトリ: 無制限
- プライベートリポジトリ: 無料（GitHub Free）
- 帯域幅: 100GB/月

**評価**: 
- ✅ **完全無料**
- **年間コスト: ¥0**

#### 3. LINE LIFF

**無料プラン**:
- LIFFアプリ: 無料
- API呼び出し: 無料

**評価**: 
- ✅ **完全無料**
- **年間コスト: ¥0**

#### 4. ドメイン（オプション）

**カスタムドメインを使用する場合**:
- 例: `.com`ドメイン: 約¥1,500/年
- 例: `.jp`ドメイン: 約¥3,000/年

**評価**: 
- オプション（GitHub Pagesの無料ドメインでも可）
- **年間コスト: ¥0〜¥3,000**

---

## 📊 コスト総計

### シナリオ1: 小規模運用（月間100件以下）

| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase (Free) | ¥0 | ¥0 |
| GitHub Pages | ¥0 | ¥0 |
| LINE LIFF | ¥0 | ¥0 |
| ドメイン（オプション） | ¥0 | ¥0 |
| **合計** | **¥0** | **¥0** |

### シナリオ2: 中規模運用（月間500件以上）

| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase (Pro) | ¥3,750 | ¥45,000 |
| GitHub Pages | ¥0 | ¥0 |
| LINE LIFF | ¥0 | ¥0 |
| ドメイン（オプション） | ¥125 | ¥1,500 |
| **合計** | **¥3,875** | **¥46,500** |

### シナリオ3: 大規模運用（月間5,000件以上）

| 項目 | 月額 | 年額 |
|------|------|------|
| Supabase (Team) | ¥7,500 | ¥90,000 |
| GitHub Pages | ¥0 | ¥0 |
| LINE LIFF | ¥0 | ¥0 |
| ドメイン | ¥250 | ¥3,000 |
| **合計** | **¥7,750** | **¥93,000** |

---

## 🎯 推奨事項

### セキュリティ対策の優先順位

1. **最優先**: SupabaseでRLS（Row Level Security）を有効化
2. **高**: 入力値検証の強化
3. **中**: XSS対策の実装
4. **低**: レート制限の追加

### コスト最適化

1. **無料プランで運用開始**: 月間50,000リクエスト以内なら無料
2. **使用量監視**: Supabaseダッシュボードで使用量を定期的に確認
3. **キャッシュ活用**: 既に実装済み（コスト削減効果あり）

---

## 📝 チェックリスト

### セキュリティ

- [ ] SupabaseでRLSを有効化
- [ ] 入力値検証を追加
- [ ] XSS対策を実装
- [ ] APIキーを環境変数に移行
- [ ] 定期的なセキュリティ監査

### コスト管理

- [ ] Supabase使用量の月次監視
- [ ] 無料プランの制限内で運用
- [ ] 必要に応じてプランアップグレード

---

**最終更新**: 2025年1月
**分析者**: AI Assistant

