<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN 89CENTER</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <style>
    /* --- 89CENTER DESIGN SYSTEM v13 (Admin Variant) --- */
    :root {
      --bg: #F5F5F7;
      --surface: #FFFFFF;
      --text: #111111;
      --sub: #888888;
      --line: #E5E5E5;
      --accent: #000000;
      --accent-light: #333333;
      --error: #FF3B30;
      --blue: #007AFF;
      
      --font-jp: "Noto Sans JP", sans-serif;
      --font-en: "Roboto", sans-serif;
      
      --radius: 4px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0; padding: 20px;
      background: var(--bg); color: var(--text);
      font-family: var(--font-jp); font-size: 13px; line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* UTILS */
    .en { font-family: var(--font-en); font-weight: 400; font-size: 0.8em; opacity: 0.6; margin-left: 4px; letter-spacing: 0.05em; text-transform: uppercase; }
    .hidden { display: none !important; }

    /* LAYOUT */
    .wrap { max-width: 1400px; margin: 0 auto; }
    
    header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: 24px; padding: 0 8px;
    }
    h1 { font-family: var(--font-en); font-size: 18px; font-weight: 800; letter-spacing: 0.05em; margin: 0; }
    .badge { background: var(--text); color: #fff; padding: 2px 6px; border-radius: 2px; font-size: 10px; margin-left: 8px; vertical-align: middle; }

    /* CONTROLS */
    .controls { display: flex; gap: 12px; }
    .btn { 
      height: 36px; padding: 0 16px; border: 1px solid var(--line); background: var(--surface);
      border-radius: 99px; font-size: 12px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .btn:hover { border-color: var(--sub); }
    .btn:active { transform: scale(0.98); }
    
    .btn-primary { background: var(--text); color: #fff; border-color: var(--text); }
    .btn-danger { color: var(--error); border-color: rgba(255,59,48,0.3); background: rgba(255,59,48,0.05); }
    
    /* DATE NAV */
    .date-nav { 
      display: flex; align-items: center; gap: 16px; 
      background: var(--surface); padding: 6px 8px; border-radius: 99px; 
      box-shadow: var(--shadow); width: fit-content; margin: 0 auto 24px;
    }
    .nav-btn {
      width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--line);
      background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .date-disp { font-family: var(--font-en); font-weight: 700; font-size: 14px; min-width: 140px; text-align: center; }

    /* GRID */
    .grid-wrap { 
      background: var(--surface); border-radius: 8px; box-shadow: var(--shadow); 
      overflow-x: auto; max-height: 80vh; 
    }
    table { width: 100%; min-width: 900px; border-collapse: collapse; table-layout: fixed; }
    
    th { 
      position: sticky; top: 0; background: rgba(255,255,255,0.98); z-index: 10;
      padding: 16px 8px; border-bottom: 2px solid var(--text); border-right: 1px solid var(--line);
      font-size: 11px; font-weight: 700; color: var(--text); text-align: center;
    }
    th:first-child { left: 0; z-index: 20; width: 60px; border-right: 2px solid var(--line); }
    
    td { 
      height: 56px; border-bottom: 1px solid var(--line); border-right: 1px solid var(--line); 
      padding: 4px; vertical-align: middle; 
    }
    td:first-child { 
      position: sticky; left: 0; background: var(--surface); z-index: 5; 
      text-align: center; font-family: var(--font-en); font-weight: 600; color: var(--sub);
      border-right: 2px solid var(--line);
    }

    /* CELLS */
    .cell { 
      width: 100%; height: 100%; border-radius: 4px; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; 
      cursor: pointer; font-size: 11px; font-weight: 500; transition: background 0.1s;
    }
    .free:hover { background: #F5F5F5; }
    .free::after { content: '+'; color: var(--line); font-size: 16px; font-weight: 300; }
    
    .booked { background: var(--text); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .booked .lbl { font-weight: 700; }
    
    .blocked { 
      background: #EEE; color: var(--sub); 
      background-image: repeating-linear-gradient(45deg, transparent, transparent 4px, #FFF 4px, #FFF 6px);
    }
    .closed { background: #FAFAFA; pointer-events: none; }
    .closed::after { content: '×'; font-family: var(--font-en); font-size: 16px; color: var(--line); }

    /* MODAL */
    .overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
      z-index: 100; display: none; align-items: center; justify-content: center;
    }
    .overlay.open { display: flex; }
    
    .box { 
      background: var(--surface); width: 420px; padding: 32px; border-radius: 12px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.2); 
    }
    .box-h { margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--text); }
    .box-ttl { font-size: 16px; font-weight: 800; margin: 0; }
    .box-sub { font-size: 10px; font-family: var(--font-en); color: var(--sub); margin-top: 4px; }

    .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
    .info-lbl { color: var(--sub); font-weight: 700; font-size: 11px; }
    .info-val { font-weight: 600; }

    .inp-group { margin-top: 24px; }
    .inp-lbl { display: block; font-size: 10px; font-weight: 700; color: var(--sub); margin-bottom: 6px; }
    .inp { 
      width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 4px; 
      font-size: 14px; margin-bottom: 12px; font-family: inherit;
    }
    .inp:focus { border-color: var(--text); }
    textarea.inp { resize: vertical; min-height: 80px; }

    .btns { display: flex; gap: 10px; margin-top: 32px; }
    .btns .btn { flex: 1; height: 44px; }

    /* LOGIN */
    #loginScreen { 
      position: fixed; inset: 0; background: var(--surface); z-index: 2000; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .login-box { width: 300px; text-align: center; }
    
    /* LOADER */
    #loader { 
      position: fixed; top: 20px; right: 20px; background: var(--text); color: #fff; 
      padding: 6px 16px; border-radius: 99px; font-size: 10px; font-weight: 700; 
      font-family: var(--font-en); letter-spacing: 0.1em; display: none; z-index: 3000;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="login-box">
      <h2 style="font-family:var(--font-en); font-size:20px; font-weight:800; margin-bottom:32px;">89CENTER <span style="font-weight:300;">ADMIN</span></h2>
      <input type="password" id="passcode" class="inp" placeholder="PASSWORD" style="text-align:center; font-family:var(--font-en); letter-spacing:0.2em;">
      <button class="btn btn-primary" style="width:100%; margin-top:16px;" onclick="checkPass()">LOGIN</button>
    </div>
  </div>

  <div id="loader">PROCESSING...</div>

  <div class="wrap">
    <header>
      <div>
        <h1>89CENTER<span class="badge">ADMIN</span></h1>
      </div>
      <div class="controls">
        <button class="btn" onclick="openMod('blockMod')">一括ブロック<span class="en">BULK BLOCK</span></button>
        <button class="btn" onclick="location.reload()">更新<span class="en">REFRESH</span></button>
      </div>
    </header>

    <div class="date-nav">
      <button class="nav-btn" onclick="move(-1)">‹</button>
      <div class="date-disp" id="dDisp">YYYY.MM.DD</div>
      <button class="nav-btn" onclick="move(1)">›</button>
    </div>

    <div class="grid-wrap">
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="overlay" id="detailMod">
    <div class="box">
      <div class="box-h">
        <h3 class="box-ttl">予約詳細</h3>
        <div class="box-sub">BOOKING DETAILS</div>
      </div>
      <div id="info"></div>
      <div class="inp-group">
        <label class="inp-lbl">管理者メモ<span class="en">ADMIN MEMO</span></label>
        <textarea id="memo" class="inp" placeholder="共有事項などを入力"></textarea>
      </div>
      <div class="btns">
        <button class="btn btn-danger" onclick="runCancel()">キャンセル実行<span class="en">CANCEL</span></button>
        <button class="btn" onclick="closeAll()">閉じる<span class="en">CLOSE</span></button>
      </div>
    </div>
  </div>

  <!-- Action Modal -->
  <div class="overlay" id="actMod">
    <div class="box">
      <div class="box-h">
        <h3 class="box-ttl">スロット操作</h3>
        <div class="box-sub">SLOT ACTION</div>
      </div>
      <div style="text-align:center; margin-bottom:32px; font-weight:600; font-size:16px;" id="actTgt"></div>
      <div class="btns">
        <button class="btn" onclick="openMod('blockMod')">ブロック<span class="en">BLOCK</span></button>
        <button class="btn btn-primary" onclick="openMod('createMod')">予約作成<span class="en">CREATE</span></button>
      </div>
      <button class="btn" style="width:100%; margin-top:12px;" onclick="closeAll()">閉じる</button>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="overlay" id="createMod">
    <div class="box">
      <div class="box-h">
        <h3 class="box-ttl">新規予約作成</h3>
        <div class="box-sub">NEW BOOKING</div>
      </div>
      <input id="cName" class="inp" placeholder="氏名">
      <input id="cPhone" class="inp" placeholder="電話番号">
      <div class="btns">
        <button class="btn" onclick="closeAll()">中止</button>
        <button class="btn btn-primary" onclick="runCreate()">確定</button>
      </div>
    </div>
  </div>

  <!-- Block Modal -->
  <div class="overlay" id="blockMod">
    <div class="box">
      <div class="box-h">
        <h3 class="box-ttl">ブロック設定</h3>
        <div class="box-sub">BLOCK SETTING</div>
      </div>
      <input id="bReason" class="inp" placeholder="理由 (例: 休憩、外出)">
      <div class="btns">
        <button class="btn btn-danger" onclick="runBlock(false)">解除<span class="en">UNBLOCK</span></button>
        <button class="btn btn-primary" onclick="runBlock(true)">実行<span class="en">BLOCK</span></button>
      </div>
      <button class="btn" style="width:100%; margin-top:12px;" onclick="closeAll()">閉じる</button>
    </div>
  </div>

<script>
// ★ CONFIG ★
const SUPABASE_URL = 'https://zzezehgnzeneueklxduy.supabase.co';
const SUPABASE_KEY = 'sb_publishable_J5lxwjP27PycJD78Jkgzsw_VhW4ThgJ';
const PASS_CODE = "admin89"; // Password
const STAFFS = ['麻生川','岡野','堀江','松田','山口'];

// Init Client
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let s = { date: new Date(), data: {}, cur: null, id: null };

window.onload = () => { /* Login Wait */ };

function checkPass(){
  if(document.getElementById('passcode').value === PASS_CODE){
    document.getElementById('loginScreen').style.display='none';
    renderHead(); load();
  } else { alert('パスワードが違います'); }
}

async function load() {
  document.getElementById('loader').style.display='block';
  const dStr = fmt(s.date);
  document.getElementById('dDisp').textContent = dStr;
  
  const { data: books } = await db.from('bookings').select('*').eq('date', dStr).neq('status','キャンセル');
  const { data: blocks } = await db.from('blocks').select('*').eq('date', dStr);
  
  const res = {}; const times = genSlots();
  STAFFS.forEach(nm => {
    res[nm] = {}; times.forEach(t => res[nm][t] = { status:'free', label:'' });
  });
  
  if(blocks) blocks.forEach(b => { if(res[b.staff]) res[b.staff][b.time] = { status:'blocked', label:b.reason||'BLOCK' }; });
  if(books) books.forEach(b => {
    let t = b.start_time;
    const endSlots = [t, addTime(t, 30)];
    endSlots.forEach(slot => {
        if(res[b.staff] && res[b.staff][slot]) res[b.staff][slot] = { status:'booked', label:b.patient_name, id:b.id, detail:b };
    });
  });
  
  s.data = res; renderGrid();
  document.getElementById('loader').style.display='none';
}

function renderHead() {
  let h='<tr><th>TIME</th>'; 
  STAFFS.forEach(n=>h+=`<th>${n}<br><span style="font-size:9px; font-weight:400; color:#888;">${getEn(n)}</span></th>`); 
  document.getElementById('thead').innerHTML=h+'</tr>';
}
function getEn(n){ const m={'麻生川':'ASOGAWA','岡野':'OKANO','堀江':'HORIE','松田':'MATSUDA','山口':'YAMAGUCHI'}; return m[n]||''; }

function renderGrid() {
  const b=document.getElementById('tbody'); b.innerHTML='';
  genSlots().forEach(t => {
    const tr=document.createElement('tr'); let h=`<td>${t}</td>`;
    STAFFS.forEach(nm => {
      const c = s.data[nm][t];
      h+=`<td><div class="cell ${c.status}" onclick="cellClick('${nm}','${t}')"><span class="lbl">${c.label}</span></div></td>`;
    });
    tr.innerHTML=h; b.appendChild(tr);
  });
}

function cellClick(nm, t) {
  const c = s.data[nm][t];
  const st = c.status;
  s.cur = { staff:nm, time:t }; s.id = c.id;
  
  if(st==='booked') {
    const d = c.detail;
    document.getElementById('info').innerHTML = `
      <div class="info-row"><span class="info-lbl">氏名 <span class="en">NAME</span></span><span class="info-val" style="font-size:16px;">${d.patient_name}</span></div>
      <div class="info-row"><span class="info-lbl">電話 <span class="en">PHONE</span></span><span class="info-val">${d.phone}</span></div>
      <div class="info-row"><span class="info-lbl">症状 <span class="en">NOTE</span></span><span class="info-val" style="font-weight:400;">${d.symptoms||'-'}</span></div>
    `;
    // Admin Memo Logic (Simplified: Load/Save logic implies DB update needed if persist)
    document.getElementById('memo').value = ""; 
    openMod('detailMod');
  } else if(st==='blocked') {
    document.getElementById('bReason').value = c.label === 'BLOCK' ? '' : c.label;
    openMod('blockMod');
  } else if(st==='free') {
    document.getElementById('actTgt').innerHTML = `${nm}<br><span style="font-family:var(--font-en); font-weight:400; font-size:14px;">${t}</span>`;
    openMod('actMod');
  }
}

async function runCreate() {
  const name = document.getElementById('cName').value;
  if(!name) return;
  const id = Math.random().toString(36).substr(2, 9).toUpperCase();
  const ph = document.getElementById('cPhone').value;
  await db.from('bookings').insert({ id, date:fmt(s.date), start_time:s.cur.time, end_time:addTime(s.cur.time,60), staff:s.cur.staff, patient_name:name, phone:ph, status:'予約済み' });
  closeAll(); load();
}
async function runCancel() {
  if(!confirm('キャンセルしてよろしいですか？')) return;
  await db.from('bookings').update({ status:'キャンセル' }).eq('id', s.id);
  closeAll(); load();
}
async function runBlock(enable) {
  if(enable) {
    await db.from('blocks').insert({ date:fmt(s.date), time:s.cur.time, staff:s.cur.staff, reason:document.getElementById('bReason').value });
  } else {
    // 簡易的に時間とスタッフで解除 (ID特定していないため)
    await db.from('blocks').delete().match({ date:fmt(s.date), time:s.cur.time, staff:s.cur.staff });
  }
  closeAll(); load();
}

function move(n) { s.date.setDate(s.date.getDate()+n); load(); }
function openMod(id) { 
  document.querySelectorAll('.overlay').forEach(e=>e.classList.remove('open'));
  document.getElementById(id).classList.add('open'); 
}
function closeAll() { document.querySelectorAll('.overlay').forEach(e=>e.classList.remove('open')); }
function fmt(d) { return d.toISOString().split('T')[0]; }
function genSlots() { const a=[]; for(let h=9;h<21;h++) for(let m=0;m<60;m+=30) a.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2)); return a; }
function addTime(t, m) { let [hh,mm]=t.split(':').map(Number); mm+=m; while(mm>=60){hh++;mm-=60;} return ('0'+hh).slice(-2)+':'+('0'+mm).slice(-2); }
</script>
</body>
</html>
