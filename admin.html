<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ADMIN 89CENTER</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* --- 89CENTER ADMIN SYSTEM v21 (Auth Fixed) --- */
    :root {
      --bg: #F9FAFB; --surface: #FFFFFF; --text: #111827; --sub: #6B7280; --line: #E5E7EB;
      --accent: #111827; --blue: #3B82F6; --red: #EF4444; --green: #10B981;
      --radius-l: 16px; --radius-m: 12px; --radius-s: 8px;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
      --font-jp: "Noto Sans JP", sans-serif; --font-en: "Roboto", sans-serif;
    }

    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0; padding: 24px; background: var(--bg); color: var(--text);
      font-family: var(--font-jp); font-size: 13px; -webkit-font-smoothing: antialiased;
    }

    .en { font-family: var(--font-en); font-weight: 500; font-size: 0.85em; opacity: 0.5; margin-left: 6px; letter-spacing: 0.05em; text-transform: uppercase; }
    .hidden { display: none !important; }
    .flex { display: flex; align-items: center; }
    .w-full { width: 100%; }

    /* LAYOUT */
    .wrap { max-width: 1400px; margin: 0 auto; display: none; /* Loginå¾Œã«è¡¨ç¤º */ }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; height: 48px; }
    
    .header-left { display: flex; align-items: center; gap: 40px; }
    
    h1 { font-family: var(--font-en); font-size: 22px; font-weight: 900; letter-spacing: 0.02em; margin: 0; display: flex; align-items: center; color: var(--accent); }
    .badge { background: var(--text); color: #fff; padding: 3px 8px; border-radius: 4px; font-size: 10px; margin-left: 10px; vertical-align: middle; font-weight: 700; letter-spacing: 0.05em; font-family: var(--font-jp); }

    /* TABS */
    .tabs { display: flex; gap: 4px; background: var(--surface); padding: 4px; border-radius: 99px; border: 1px solid var(--line); box-shadow: var(--shadow); }
    .tab { 
      padding: 8px 24px; border-radius: 99px; cursor: pointer; font-weight: 700; font-size: 12px; 
      color: var(--sub); border: none; background: transparent; transition: all 0.2s; 
    }
    .tab:hover { color: var(--text); }
    .tab.active { background: var(--text); color: #fff; }

    /* BUTTONS */
    .btn { height: 40px; padding: 0 20px; border: 1px solid transparent; background: var(--surface); border-radius: 99px; font-size: 12px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: var(--shadow); color: var(--text); }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--text); color: #fff; border-color: var(--text); }
    .btn-danger { color: var(--red); background: #FEF2F2; border: 1px solid #FECACA; box-shadow: none; }
    .btn-ghost { background: transparent; box-shadow: none; border: 1px solid var(--line); }

    /* SCHEDULE VIEW */
    .date-nav { display: flex; align-items: center; gap: 16px; background: var(--surface); padding: 6px 16px; border-radius: 99px; box-shadow: var(--shadow); width: fit-content; margin: 0 auto 24px; }
    .nav-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--line); background: var(--bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .nav-btn:hover { background: var(--text); color: #fff; }
    .date-disp { font-family: var(--font-en); font-weight: 700; font-size: 15px; min-width: 140px; text-align: center; letter-spacing: 0.05em; }
    .date-wrapper { display: flex; align-items: center; gap: 10px; position: relative; cursor: pointer; }
    .cal-icon { width: 18px; height: 18px; opacity: 0.4; transition: opacity 0.2s; }
    .date-wrapper:hover .cal-icon { opacity: 1; }
    #datePicker { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    .grid-wrap { background: var(--surface); border-radius: var(--radius-l); box-shadow: var(--shadow); overflow-x: auto; max-height: 75vh; border: 1px solid var(--line); }
    table { width: 100%; min-width: 900px; border-collapse: separate; border-spacing: 0; table-layout: fixed; }
    th { position: sticky; top: 0; background: rgba(255,255,255,0.98); z-index: 10; padding: 16px; border-bottom: 1px solid var(--line); font-size: 11px; font-weight: 700; color: var(--sub); text-align: center; }
    th:first-child { left: 0; z-index: 20; width: 80px; border-right: 1px solid var(--line); }
    td { height: 60px; border-bottom: 1px solid var(--line); border-right: 1px dashed var(--line); padding: 4px; vertical-align: middle; }
    td:last-child { border-right: none; }
    td:first-child { position: sticky; left: 0; background: var(--surface); z-index: 5; text-align: center; font-family: var(--font-en); font-weight: 600; color: var(--sub); border-right: 1px solid var(--line); }

    .cell { width: 100%; height: 100%; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s; overflow: hidden; }
    .free:hover { background: #F3F4F6; }
    .booked { background: var(--text); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .blocked { background: #F3F4F6; color: var(--sub); background-image: repeating-linear-gradient(45deg, transparent, transparent 4px, #FFF 4px, #FFF 6px); }
    .closed { background: #FAFAFA; pointer-events: none; opacity: 0.5; }

    /* DASHBOARD VIEW */
    .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
    .kpi-card { background: var(--surface); padding: 24px; border-radius: var(--radius-l); box-shadow: var(--shadow); border: 1px solid var(--line); }
    .kpi-lbl { font-size: 11px; font-weight: 700; color: var(--sub); text-transform: uppercase; letter-spacing: 0.05em; }
    .kpi-val { font-size: 28px; font-weight: 800; font-family: var(--font-en); margin-top: 8px; color: var(--text); }
    .kpi-sub { font-size: 11px; color: var(--green); font-weight: 700; margin-top: 4px; }

    .chart-row { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
    .chart-box { background: var(--surface); padding: 24px; border-radius: var(--radius-l); box-shadow: var(--shadow); border: 1px solid var(--line); height: 400px; display: flex; flex-direction: column; }
    .chart-ttl { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
    .chart-area { flex: 1; position: relative; }

    /* Staff Stats List */
    .staff-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--line); }
    .staff-row:last-child { border-bottom: none; }
    .s-name { font-weight: 700; font-size: 13px; }
    .s-data { text-align: right; }
    .s-cnt { font-size: 11px; color: var(--sub); margin-right: 8px; font-family: var(--font-en); }
    .s-amt { font-family: var(--font-en); font-weight: 700; font-size: 14px; }

    /* SEARCH VIEW */
    .search-box { display: flex; gap: 10px; margin-bottom: 24px; }
    .inp-search { flex: 1; padding: 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background: #fff; }
    .result-list { display: grid; gap: 16px; }
    .res-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--line); box-shadow: var(--shadow); }
    .res-header { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid var(--line); padding-bottom: 8px; }
    .res-name { font-size: 16px; font-weight: 700; }
    .res-date { font-family: var(--font-en); font-weight: 700; color: var(--sub); }
    .res-detail { font-size: 13px; color: var(--text); line-height: 1.6; }
    .res-memo { font-size: 12px; color: var(--sub); background: #F3F4F6; padding: 8px; border-radius: 6px; margin-top: 12px; }
    .res-tag { display: inline-block; background: var(--text); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 8px; }

    /* MODAL */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    .overlay.open { display: flex; opacity: 1; }
    .box { background: var(--surface); width: 440px; padding: 32px; border-radius: var(--radius-l); box-shadow: 0 20px 60px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s; }
    .overlay.open .box { transform: scale(1); }
    .box-h { margin-bottom: 24px; text-align: center; }
    .box-ttl { font-size: 16px; font-weight: 800; }
    
    .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
    .info-lbl { color: var(--sub); font-weight: 700; font-size: 11px; }
    .info-val { font-weight: 600; font-family: var(--font-en); }

    .inp { width: 100%; padding: 12px; border: 1px solid var(--line); border-radius: 8px; font-size: 14px; background: #FAFAFA; margin-bottom: 16px; }
    .inp:focus { border-color: var(--text); background: #fff; }
    textarea.inp { min-height: 80px; resize: vertical; }
    .inp-row { display: flex; gap: 10px; } .inp-row .inp { margin-bottom: 0; }

    /* Spaced out Bulk Block Form */
    #bulkMod .inp-group { margin-bottom: 24px; }
    #bulkMod .inp-lbl { margin-bottom: 8px; }

    .staff-checks { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
    .s-chk { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; padding: 8px; border: 1px solid var(--line); border-radius: 6px; cursor: pointer; }
    .s-chk:hover { background: #FAFAFA; }
    .s-chk input { accent-color: var(--text); }

    .btns { display: flex; gap: 10px; margin-top: 24px; width: 100%; }
    .btns .btn { flex: 1; }

    /* LOGIN */
    #loginScreen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.3s; }
    #loader.show { opacity: 1; }
    .spinner { width: 40px; height: 40px; border-radius: 50%; border: 3px solid rgba(0,0,0,0.1); border-top-color: var(--text); animation: spin 1s infinite; margin-bottom: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* TOAST */
    .toast { 
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); 
      background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(4px);
      color: #fff; padding: 10px 20px; border-radius: 99px; 
      font-size: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0; transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1); pointer-events: none; z-index: 4000; 
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>

  <div id="loginScreen">
    <div style="text-align:center; width:320px;">
      <h2 style="font-family:var(--font-en); font-weight:900; margin-bottom:32px;">89CENTER ADMIN</h2>
      <input type="email" id="email" class="inp" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="text-align:center; letter-spacing:0.05em; margin-bottom:12px;">
      <input type="password" id="password" class="inp" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="text-align:center; letter-spacing:0.1em;">
      <button class="btn btn-primary w-full" style="margin-top:12px;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <p id="loginError" style="color:var(--red); font-size:12px; margin-top:16px; display:none;"></p>
    </div>
  </div>

  <div id="loader"><div class="spinner"></div><div style="font-family:var(--font-en); font-weight:700; font-size:10px; letter-spacing:0.2em;">LOADING</div></div>
  <div id="toast" class="toast"></div>

  <div class="wrap" id="mainApp">
    <header>
      <div class="header-left">
        <h1>89CENTER<span class="badge">ç®¡ç†ç”»é¢</span></h1>
        <div class="tabs">
          <button class="tab active" onclick="switchTab('schedule')">äºˆç´„ç®¡ç†</button>
          <button class="tab" onclick="switchTab('search')">æ‚£è€…æ¤œç´¢</button>
          <button class="tab" onclick="switchTab('dashboard')">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        </div>
      </div>
      <div class="header-right" style="display:flex; gap:12px;">
        <button id="bulkBtn" class="btn btn-danger" onclick="openMod('bulkMod')">ä¸€æ‹¬ãƒ–ãƒ­ãƒƒã‚¯</button>
        <button class="btn btn-ghost" onclick="openFeeModal()">æ–™é‡‘è¨­å®š</button>
        <button class="btn btn-ghost" onclick="refreshData()">æ›´æ–°</button>
        <button class="btn btn-ghost" style="width:auto; padding:0 12px;" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </header>

    <!-- SCHEDULE -->
    <div id="viewSchedule">
      <div class="date-nav">
        <button class="nav-btn" onclick="move(-1)">â€¹</button>
        <div class="date-wrapper" onclick="document.getElementById('datePicker').showPicker()">
          <div class="date-disp" id="dDisp">YYYY.MM.DD</div>
          <svg class="cal-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <input type="date" id="datePicker">
        </div>
        <button class="nav-btn" onclick="move(1)">â€º</button>
      </div>
      <div class="grid-wrap">
        <table id="tbl"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
      </div>
    </div>

    <!-- SEARCH -->
    <div id="viewSearch" class="hidden">
      <div class="search-box">
        <input id="sKeyword" class="inp-search" placeholder="åå‰ ã¾ãŸã¯ é›»è©±ç•ªå· ã§æ¤œç´¢...">
        <button class="btn btn-primary" style="margin-left:8px;" onclick="runSearch()">æ¤œç´¢</button>
      </div>
      <div id="sResult" class="result-list">
        <div style="text-align:center; color:var(--sub); padding:40px;">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="viewDashboard" class="hidden">
      <div style="margin-bottom:20px; text-align:right;">
        <select id="dashMonth" class="inp" style="width:auto; margin:0;" onchange="loadDashboard()"></select>
      </div>

      <div class="dash-grid">
        <div class="kpi-card"><div class="kpi-lbl">Total Sales</div><div class="kpi-val" id="kpiSales">Â¥0</div><div class="kpi-sub">æœˆé–“å£²ä¸Šåˆè¨ˆ</div></div>
        <div class="kpi-card"><div class="kpi-lbl">Total Bookings</div><div class="kpi-val" id="kpiCount">0</div><div class="kpi-sub">äºˆç´„ä»¶æ•°</div></div>
        <div class="kpi-card"><div class="kpi-lbl">Avg. Price</div><div class="kpi-val" id="kpiAvg">Â¥0</div><div class="kpi-sub">å¹³å‡å®¢å˜ä¾¡</div></div>
      </div>

      <div class="chart-row">
        <div class="chart-box">
          <div class="chart-ttl">ã‚¹ã‚¿ãƒƒãƒ•åˆ¥å®Ÿç¸¾</div>
          <div class="chart-area" style="overflow-y:auto;" id="staffList"></div>
        </div>
        <div class="chart-box">
          <div class="chart-ttl">æœˆé–“å£²ä¸Šæ¨ç§» (ç´¯ç©)</div>
          <div class="chart-area"><canvas id="chartLine"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="detailMod" onclick="if(event.target===this)closeAll()">
    <div class="box">
      <div class="box-h"><h3 class="box-ttl">äºˆç´„è©³ç´°</h3></div>
      <div id="info"></div>
      <div class="inp-group">
        <label class="inp-lbl">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
        <textarea id="memo" class="inp" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›ï¼ˆè‡ªå‹•ä¿å­˜ï¼‰"></textarea>
      </div>
      <div class="btns"><button class="btn btn-danger" onclick="runCancel()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Ÿè¡Œ</button><button class="btn btn-ghost" onclick="closeAll()">é–‰ã˜ã‚‹</button></div>
    </div>
  </div>

  <!-- Action Modal -->
  <div class="overlay" id="actionMod" onclick="if(event.target===this)closeAll()">
    <div class="box">
      <div class="box-h"><h3 class="box-ttl">ã‚¹ãƒ­ãƒƒãƒˆæ“ä½œ</h3></div>
      <div style="text-align:center; margin-bottom:24px; font-weight:700;" id="actTarget"></div>
      <div class="btns">
        <button class="btn" onclick="openMod('blockMod')">ãƒ–ãƒ­ãƒƒã‚¯</button>
        <button class="btn btn-primary" onclick="openMod('createMod')">äºˆç´„ä½œæˆ</button>
      </div>
      <button class="btn btn-ghost w-full" style="margin-top:12px; border:none; color:var(--sub);" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div class="overlay" id="createMod" onclick="if(event.target===this)closeAll()">
    <div class="box">
      <div class="box-h"><h3 class="box-ttl">æ–°è¦äºˆç´„ä½œæˆ</h3></div>
      <div class="inp-group"><label class="inp-lbl">æ°å</label><input id="cName" class="inp" placeholder="æ°åã‚’å…¥åŠ›"></div>
      <div class="inp-group"><label class="inp-lbl">é›»è©±ç•ªå·</label><input id="cPhone" class="inp" placeholder="090-0000-0000"></div>
      <div class="inp-group"><label class="inp-lbl">ç—‡çŠ¶ãƒ»å‚™è€ƒ</label><textarea id="cSym" class="inp" placeholder="ç—‡çŠ¶ãƒ»å‚™è€ƒã‚’å…¥åŠ›"></textarea></div>
      <div class="btns">
        <button class="btn btn-ghost" onclick="closeAll()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="runCreate()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- Single Block Modal -->
  <div class="overlay" id="blockMod" onclick="if(event.target===this)closeAll()">
    <div class="box">
      <div class="box-h"><h3 class="box-ttl">ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</h3></div>
      <div class="inp-group">
        <label class="inp-lbl">ç†ç”±</label>
        <input id="sBlkReason" class="inp" placeholder="ç†ç”± (ä¾‹: ä¼‘æ†©)">
      </div>
      <div class="btns">
        <button class="btn btn-ghost" onclick="closeAll()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" onclick="runSingleBlock()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>

  <!-- Unblock Modal -->
  <div class="overlay" id="unblockMod" onclick="if(event.target===this)closeAll()">
    <div class="box">
      <div class="box-h"><h3 class="box-ttl">ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤</h3></div>
      <p style="text-align:center; margin-bottom:24px; color:var(--text);">ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      <div style="text-align:center; margin-bottom:24px; font-weight:700; color:var(--sub);" id="unblkTarget"></div>
      <div class="btns">
        <button class="btn btn-ghost" onclick="closeAll()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-danger" onclick="runSingleUnblock()">è§£é™¤å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="bulkMod" onclick="if(event.target===this)closeAll()">
    <div class="box" style="width:520px;">
      <div class="box-h"><h3 class="box-ttl">ä¸€æ‹¬ãƒ–ãƒ­ãƒƒã‚¯è¨­å®š</h3></div>
      <div class="inp-group">
        <label class="inp-lbl">æœŸé–“</label>
        <div class="inp-row">
          <input type="date" id="blkFrom" class="inp">
          <span style="padding-top:10px;">ã€œ</span>
          <input type="date" id="blkTo" class="inp">
        </div>
      </div>
      <div class="inp-group">
        <label class="inp-lbl">æ™‚é–“å¸¯</label>
        <div class="inp-row">
          <select id="blkStart" class="inp"></select>
          <span style="padding-top:10px;">ã€œ</span>
          <select id="blkEnd" class="inp"></select>
        </div>
      </div>
      <div class="inp-group">
        <label class="inp-lbl">å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•</label>
        <div class="staff-checks" id="blkStaff"></div>
      </div>
      <div class="inp-group">
        <label class="inp-lbl">ç†ç”±</label>
        <input id="blkReason" class="inp" placeholder="ç†ç”±ã‚’å…¥åŠ› (ä¾‹: ç ”ä¿®)">
      </div>
      <div class="btns">
        <button class="btn btn-ghost" onclick="runBulk(false)">è§£é™¤</button>
        <button class="btn btn-danger" onclick="runBulk(true)">ãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œ</button>
      </div>
      <button class="btn btn-ghost w-full" style="margin-top:12px; border:none; color:var(--sub);" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- Fee Setting Modal -->
  <div class="overlay" id="feeMod" onclick="if(event.target===this)closeAll()">
    <div class="box" style="width:420px;">
      <div class="box-h"><h3 class="box-ttl">ã‚¹ã‚¿ãƒƒãƒ•æ–™é‡‘è¨­å®š</h3></div>
      <div id="feeList" style="display:grid; gap:12px; margin-bottom:24px;"></div>
      <div class="btns">
        <button class="btn btn-ghost" onclick="closeAll()">é–‰ã˜ã‚‹</button>
        <button class="btn btn-primary" onclick="saveFees()">ä¿å­˜</button>
      </div>
    </div>
  </div>

<script>
// CONFIG
const SUPABASE_URL = 'https://zzezehgnzeneueklxduy.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_J5lxwjP27PycJD78Jkgzsw_VhW4ThgJ';
const STAFFS = ['éº»ç”Ÿå·','å²¡é‡','å €æ±Ÿ','æ¾ç”°','å±±å£'];
const FEES = {'éº»ç”Ÿå·':16500,'å²¡é‡':11000,'å €æ±Ÿ':11000,'æ¾ç”°':11000,'å±±å£':11000};
const TIMES = []; for(let h=9;h<21;h++) for(let m=0;m<60;m+=30) TIMES.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2));

const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let s = { date: new Date(), data: {}, cur: null, id: null };
let chartInst = null;
let currentTab = 'schedule';
let FEES = {'éº»ç”Ÿå·':16500,'å²¡é‡':11000,'å €æ±Ÿ':11000,'æ¾ç”°':11000,'å±±å£':11000}; // å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹

// ãƒ¡ãƒ¢æ›´æ–°ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆ1ç§’å¾…ã£ã¦ã‹ã‚‰ä¿å­˜ï¼‰
let memoUpdateTimer = null;
const MEMO_DEBOUNCE_MS = 1000;

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
const ADMIN_CACHE_PREFIX = '89admin_';
const ADMIN_CACHE_EXPIRY = 3 * 60 * 1000; // 3åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥

function getAdminCacheKey(dateStr) {
  return ADMIN_CACHE_PREFIX + dateStr;
}

function getAdminCachedData(dateStr) {
  try {
    const cached = localStorage.getItem(getAdminCacheKey(dateStr));
    if (!cached) return null;
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp > ADMIN_CACHE_EXPIRY) {
      localStorage.removeItem(getAdminCacheKey(dateStr));
      return null;
    }
    return data;
  } catch (e) {
    return null;
  }
}

function setAdminCachedData(dateStr, data) {
  try {
    localStorage.setItem(getAdminCacheKey(dateStr), JSON.stringify({
      data,
      timestamp: Date.now()
    }));
  } catch (e) {}
}

function clearAdminCache() {
  try {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith(ADMIN_CACHE_PREFIX)) {
        localStorage.removeItem(key);
      }
    });
  } catch (e) {}
}

window.onload = async () => {
  // Supabaseæ¥ç¶šç¢ºèª
  try {
    console.log('Supabase URL:', SUPABASE_URL);
    console.log('Supabaseæ¥ç¶šç¢ºèªä¸­...');
    
    // Session Check
    const { data: { session }, error: sessionError } = await db.auth.getSession();
    
    if (sessionError) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', sessionError);
    }
    
    if (session) {
      console.log('æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
      await loadFees(); // æ–™é‡‘ã‚’DBã‹ã‚‰èª­ã¿è¾¼ã‚€
      showMain();
    } else {
      console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºã—ã¾ã™');
      document.getElementById('loginScreen').style.display = 'flex';
    }
  } catch (e) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
    document.getElementById('loginScreen').style.display = 'flex';
    const errEl = document.getElementById('loginError');
    if (errEl) {
      errEl.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + e.message;
      errEl.style.display = 'block';
    }
  }

  // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã®è¨­å®š
  document.getElementById('datePicker').onchange = (e) => { if(e.target.value){ s.date = new Date(e.target.value); load(); } };
  
  // æ™‚é–“é¸æŠã®è¨­å®š
  const ts=document.getElementById('blkStart'), te=document.getElementById('blkEnd');
  TIMES.forEach(t => { ts.add(new Option(t, t)); te.add(new Option(t, t)); }); te.value = "20:30"; 
  
  // ã‚¹ã‚¿ãƒƒãƒ•ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¨­å®š
  const sc=document.getElementById('blkStaff');
  STAFFS.forEach(nm => { sc.innerHTML += `<label class="s-chk"><input type="checkbox" value="${nm}" checked> ${nm}</label>`; });
  
  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœˆé¸æŠã®è¨­å®š
  const dm=document.getElementById('dashMonth'), today=new Date();
  for(let i=0; i<12; i++) {
    const d=new Date(today.getFullYear(), today.getMonth()-i, 1);
    dm.add(new Option(`${d.getFullYear()}å¹´ ${d.getMonth()+1}æœˆ`, fmtLocal(d).substr(0,7)));
  }
  
  // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
  document.getElementById('email').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') document.getElementById('password').focus();
  });
  document.getElementById('password').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') handleLogin();
  });
};

async function handleLogin() {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';

  if(!email || !password) {
    errEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    errEl.style.display = 'block';
    return;
  }
  
  showLoad(true);
  try {
    console.log('ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', email);
    const { data, error } = await db.auth.signInWithPassword({ email, password });
    
    if (error) {
      console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
      let errorMsg = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ';
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªåŒ–
      if (error.message.includes('Invalid login credentials')) {
        errorMsg += 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
      } else if (error.message.includes('Email not confirmed')) {
        errorMsg += 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
      } else if (error.message.includes('Too many requests')) {
        errorMsg += 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
      } else {
        errorMsg += error.message;
      }
      
      errEl.textContent = errorMsg;
      errEl.style.display = 'block';
    } else {
      console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', data);
      await loadFees(); // æ–™é‡‘ã‚’èª­ã¿è¾¼ã‚€
      showMain();
    }
  } catch (e) {
    console.error('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', e);
    errEl.textContent = 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message;
    errEl.style.display = 'block';
  } finally {
    showLoad(false);
  }
}

async function handleLogout() {
  await db.auth.signOut();
  location.reload();
}

function showMain() {
  document.getElementById('loginScreen').style.display = 'none';
  document.querySelector('.wrap').style.display = 'block';
  renderHead();
  load();
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
  document.querySelectorAll('[onclick="switchTab(\''+tab+'\')"]').forEach(e => e.classList.add('active'));
  document.getElementById('viewSchedule').classList.toggle('hidden', tab!=='schedule');
  document.getElementById('viewSearch').classList.toggle('hidden', tab!=='search');
  document.getElementById('viewDashboard').classList.toggle('hidden', tab!=='dashboard');
  document.getElementById('bulkBtn').style.display = tab==='schedule' ? 'inline-flex' : 'none';
  if(tab==='dashboard') loadDashboard();
}

function refreshData() {
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  clearAdminCache();
  if(currentTab === 'dashboard') loadDashboard();
  else if(currentTab === 'search') runSearch();
  else load();
}

// SCHEDULE
async function load() {
  showLoad(true);
  const dStr = fmtLocal(s.date);
  document.getElementById('dDisp').textContent = dStr;
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
  const cached = getAdminCachedData(dStr);
  if (cached) {
    s.data = cached;
    renderGrid();
    showLoad(false);
    return;
  }
  
  // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  const { data: books } = await db.from('bookings')
    .select('id, start_time, staff, patient_name, admin_memo')
    .eq('date', dStr)
    .neq('status','ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  const { data: blocks } = await db.from('blocks')
    .select('staff, time, reason')
    .eq('date', dStr);
  
  const res = {}; 
  STAFFS.forEach(nm => { res[nm] = {}; TIMES.forEach(t => res[nm][t] = { status:'free', label:'' }); });
  
  if(blocks) blocks.forEach(b => { 
    if(res[b.staff] && res[b.staff][b.time]) {
        res[b.staff][b.time] = { status:'blocked', label:b.reason||'BLOCK' }; 
    }
  });
  if(books) books.forEach(b => {
    let t = b.start_time;
    [t, addTime(t, 30)].forEach(slot => {
        if(res[b.staff] && res[b.staff][slot]) {
          res[b.staff][slot] = { 
            status:'booked', 
            label:b.patient_name, 
            id:b.id, 
            detail:b 
          };
        }
    });
  });
  s.data = res; 
  setAdminCachedData(dStr, res);
  renderGrid(); 
  showLoad(false);
}

function renderHead() { let h='<tr><th></th>'; STAFFS.forEach(n=>h+=`<th>${n}</th>`); document.getElementById('thead').innerHTML=h+'</tr>'; }
function renderGrid() {
  const b=document.getElementById('tbody'); b.innerHTML='';
  TIMES.forEach(t => {
    const tr=document.createElement('tr'); let h=`<td>${t}</td>`;
    STAFFS.forEach(nm => {
      const c = s.data[nm][t], lbl = c.status === 'booked' ? c.label : (c.label || '');
      h+=`<td><div class="cell ${c.status}" onclick="cellClick('${nm}','${t}')">${lbl}</div></td>`;
    });
    tr.innerHTML=h; b.appendChild(tr);
  });
}

async function cellClick(nm, t) {
  const c = s.data[nm][t]; s.cur = { staff:nm, time:t }; s.id = c.id;
  if(c.status === 'booked') {
    // è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
    const { data: detail } = await db.from('bookings')
      .select('patient_name, phone, symptoms, fee, admin_memo')
      .eq('id', c.id)
      .single();
    
    const d = detail || c.detail || {};
    document.getElementById('info').innerHTML = `
      <div class="info-row"><span class="info-lbl">æ°å</span><span class="info-val">${d.patient_name||'-'}</span></div>
      <div class="info-row"><span class="info-lbl">é›»è©±</span><span class="info-val">${d.phone||'-'}</span></div>
      <div class="info-row"><span class="info-lbl">ç—‡çŠ¶</span><span class="info-val" style="font-weight:400;">${d.symptoms||'-'}</span></div>
      <div class="info-row" style="align-items:center;">
        <span class="info-lbl">æ–™é‡‘</span>
        <div style="display:flex; align-items:center; gap:8px;">
          <input type="number" id="editFee" class="inp" value="${Number(d.fee||0)}" style="width:120px; margin:0; padding:6px 10px; font-size:13px;">
          <span style="font-size:11px; color:var(--sub);">å††</span>
        </div>
      </div>`;
    const mEl = document.getElementById('memo');
    mEl.value = d.admin_memo || '';
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ã§ãƒ¡ãƒ¢æ›´æ–°
    mEl.oninput = () => {
      clearTimeout(memoUpdateTimer);
      memoUpdateTimer = setTimeout(() => {
        updateMemo(s.id, mEl.value);
      }, MEMO_DEBOUNCE_MS);
    };
    // æ–™é‡‘ç·¨é›†ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    const feeEl = document.getElementById('editFee');
    if(feeEl) {
      feeEl.onchange = () => {
        const newFee = Number(feeEl.value);
        if(newFee >= 0) {
          updateBookingFee(s.id, newFee);
        }
      };
    }
    openMod('detailMod');
  } else if(c.status === 'free') {
    document.getElementById('actTarget').textContent = `${nm} ${t}`;
    openMod('actionMod');
    // Clear create form
    document.getElementById('cName').value = '';
    document.getElementById('cPhone').value = '';
    document.getElementById('cSym').value = '';
  } else if(c.status === 'blocked') {
    document.getElementById('unblkTarget').textContent = `${nm} ${t} (${c.label})`;
    openMod('unblockMod');
  }
}

async function runCreate() {
  const name = document.getElementById('cName').value;
  if(!name) return;
  const id = Math.random().toString(36).substr(2, 9).toUpperCase();
  const fee = FEES[s.cur.staff] ? Number(FEES[s.cur.staff]) : 0;
  
  await db.from('bookings').insert({ 
    id, date:fmtLocal(s.date), start_time:s.cur.time, end_time:addTime(s.cur.time,60), 
    staff:s.cur.staff, patient_name:name, phone:document.getElementById('cPhone').value, 
    symptoms: document.getElementById('cSym').value, fee: fee, status:'äºˆç´„æ¸ˆã¿' 
  });
  clearAdminCache();
  closeAll(); load();
}

async function runCancel() {
  if(!confirm('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
  await db.from('bookings').update({ status:'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }).eq('id', s.id);
  clearAdminCache();
  closeAll(); load();
}

async function updateMemo(id, val) {
  const { error } = await db.from('bookings').update({ admin_memo: val }).eq('id', id);
  if(!error) showToast('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

async function updateBookingFee(id, fee) {
  const { error } = await db.from('bookings').update({ fee: fee }).eq('id', id);
  if(!error) {
    showToast('æ–™é‡‘ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    clearAdminCache();
    if(currentTab === 'schedule') load();
  } else {
    showToast('æ–™é‡‘ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// æ–™é‡‘è¨­å®šé–¢é€£
async function loadFees() {
  try {
    // staffsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ–™é‡‘ã‚’å–å¾—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ï¼‰
    const { data, error } = await db.from('staffs').select('name, fee');
    if(!error && data && data.length > 0) {
      data.forEach(staff => {
        if(STAFFS.includes(staff.name)) {
          FEES[staff.name] = Number(staff.fee) || FEES[staff.name];
        }
      });
    } else {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
      const saved = localStorage.getItem('89admin_fees');
      if(saved) {
        try {
          const savedFees = JSON.parse(saved);
          STAFFS.forEach(staff => {
            if(savedFees[staff]) FEES[staff] = Number(savedFees[staff]);
          });
        } catch(e) {}
      }
    }
  } catch(e) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
    const saved = localStorage.getItem('89admin_fees');
    if(saved) {
      try {
        const savedFees = JSON.parse(saved);
        STAFFS.forEach(staff => {
          if(savedFees[staff]) FEES[staff] = Number(savedFees[staff]);
        });
      } catch(e) {}
    }
  }
}

function openFeeModal() {
  const list = document.getElementById('feeList');
  list.innerHTML = '';
  STAFFS.forEach(staff => {
    const currentFee = FEES[staff] || 0;
    list.innerHTML += `
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; border:1px solid var(--line); border-radius:8px;">
        <span style="font-weight:700; font-size:14px;">${staff}</span>
        <div style="display:flex; align-items:center; gap:8px;">
          <input type="number" id="fee_${staff}" class="inp" value="${currentFee}" style="width:120px; margin:0; padding:6px 10px; font-size:13px;">
          <span style="font-size:11px; color:var(--sub);">å††</span>
        </div>
      </div>
    `;
  });
  openMod('feeMod');
}

async function saveFees() {
  showLoad(true);
  const updates = [];
  STAFFS.forEach(staff => {
    const feeEl = document.getElementById(`fee_${staff}`);
    if(feeEl) {
      const newFee = Number(feeEl.value);
      if(newFee >= 0) {
        FEES[staff] = newFee;
        updates.push({ name: staff, fee: newFee });
      }
    }
  });
  
  // staffsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ï¼ˆupsertï¼‰
  try {
    for(const update of updates) {
      await db.from('staffs').upsert({ name: update.name, fee: update.fee }, { onConflict: 'name' });
    }
    showToast('æ–™é‡‘ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    closeAll();
  } catch(e) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('89admin_fees', JSON.stringify(FEES));
    showToast('æ–™é‡‘ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰');
    closeAll();
  }
  showLoad(false);
}

// æ‚£è€…æ¤œç´¢ã®è©³ç´°ã‚’é–‹ã
async function openSearchDetail(bookingId) {
  s.id = bookingId;
  const { data: detail } = await db.from('bookings')
    .select('patient_name, phone, symptoms, fee, admin_memo, date, start_time, staff')
    .eq('id', bookingId)
    .single();
  
  if(!detail) return;
  
  document.getElementById('info').innerHTML = `
    <div class="info-row"><span class="info-lbl">æ°å</span><span class="info-val">${detail.patient_name||'-'}</span></div>
    <div class="info-row"><span class="info-lbl">é›»è©±</span><span class="info-val">${detail.phone||'-'}</span></div>
    <div class="info-row"><span class="info-lbl">æ—¥æ™‚</span><span class="info-val">${detail.date} ${detail.start_time}</span></div>
    <div class="info-row"><span class="info-lbl">ã‚¹ã‚¿ãƒƒãƒ•</span><span class="info-val">${detail.staff||'-'}</span></div>
    <div class="info-row"><span class="info-lbl">ç—‡çŠ¶</span><span class="info-val" style="font-weight:400;">${detail.symptoms||'-'}</span></div>
    <div class="info-row" style="align-items:center;">
      <span class="info-lbl">æ–™é‡‘</span>
      <div style="display:flex; align-items:center; gap:8px;">
        <input type="number" id="editFee" class="inp" value="${Number(detail.fee||0)}" style="width:120px; margin:0; padding:6px 10px; font-size:13px;">
        <span style="font-size:11px; color:var(--sub);">å††</span>
      </div>
    </div>`;
  
  const mEl = document.getElementById('memo');
  mEl.value = detail.admin_memo || '';
  mEl.oninput = () => {
    clearTimeout(memoUpdateTimer);
    memoUpdateTimer = setTimeout(() => {
      updateMemo(s.id, mEl.value);
    }, MEMO_DEBOUNCE_MS);
  };
  
  const feeEl = document.getElementById('editFee');
  if(feeEl) {
    feeEl.onchange = () => {
      const newFee = Number(feeEl.value);
      if(newFee >= 0) {
        updateBookingFee(s.id, newFee);
      }
    };
  }
  
  openMod('detailMod');
}

async function runSingleBlock() {
  const r = document.getElementById('sBlkReason').value;
  await db.from('blocks').insert({ date:fmtLocal(s.date), time:s.cur.time, staff:s.cur.staff, reason:r });
  clearAdminCache();
  closeAll(); load();
}

async function runSingleUnblock() {
  await db.from('blocks').delete().match({ date:fmtLocal(s.date), time:s.cur.time, staff:s.cur.staff });
  clearAdminCache();
  closeAll(); load();
}

async function runBulk(enable) {
  const from = document.getElementById('blkFrom').value, to = document.getElementById('blkTo').value;
  if(!from || !to) return alert('æœŸé–“ã‚’é¸æŠ');
  showLoad(true);
  
  const dStart=new Date(from), dEnd=new Date(to), dates=[];
  for(let d=dStart; d<=dEnd; d.setDate(d.getDate()+1)) dates.push(fmtLocal(d));
  
  const tStart=document.getElementById('blkStart').value, tEnd=document.getElementById('blkEnd').value, tr=[];
  let rec=false; TIMES.forEach(t=>{ if(t===tStart)rec=true; if(rec)tr.push(t); if(t===tEnd)rec=false; });
  
  const staffs=[]; document.querySelectorAll('#blkStaff input:checked').forEach(c=>staffs.push(c.value));
  const reason=document.getElementById('blkReason').value, rows=[];
  
  dates.forEach(d => tr.forEach(t => staffs.forEach(st => rows.push({ date:d, time:t, staff:st, reason:reason }))));

  if(enable) await db.from('blocks').insert(rows);
  else for(const r of rows) await db.from('blocks').delete().match({ date:r.date, time:r.time, staff:r.staff });
  
  clearAdminCache();
  showLoad(false); closeAll(); load();
}

// SEARCH
async function runSearch() {
  const kw = document.getElementById('sKeyword').value.trim();
  if(!kw) return;
  showLoad(true);
  
  // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  const { data } = await db.from('bookings')
    .select('id, date, start_time, staff, patient_name, phone, symptoms, status, admin_memo, fee')
    .or(`patient_name.ilike.%${kw}%,phone.ilike.%${kw}%`)
    .order('date', { ascending: false });
    
  const list = document.getElementById('sResult');
  list.innerHTML = '';
  
  if(!data || data.length === 0) {
    list.innerHTML = '<div style="text-align:center; padding:40px; color:var(--sub);">è©²å½“ãªã—</div>';
  } else {
    data.forEach(b => {
      const stClass = b.status === 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' ? 'color:var(--red);' : '';
      const memoHtml = b.admin_memo ? `<div class="res-memo">ğŸ“ ${b.admin_memo}</div>` : '';
      list.innerHTML += `
        <div class="res-card" onclick="openSearchDetail('${b.id}')" style="cursor:pointer;">
          <div class="res-header">
            <div class="res-name">${b.patient_name} <span style="font-weight:400; font-size:12px; margin-left:8px; ${stClass}">${b.status}</span></div>
            <div class="res-date">${b.date} ${b.start_time}</div>
          </div>
          <div class="res-detail">
            <div><span class="res-tag">${b.staff}</span> ç—‡çŠ¶: ${b.symptoms || 'ãªã—'}</div>
            <div style="margin-top:4px; font-size:12px; color:var(--sub);">TEL: ${b.phone}</div>
            ${memoHtml}
          </div>
        </div>`;
    });
  }
  showLoad(false);
}

// DASHBOARD
async function loadDashboard() {
  showLoad(true);
  const ym = document.getElementById('dashMonth').value;
  const [y, m] = ym.split('-').map(Number);
  const start = `${ym}-01`;
  const lastDay = new Date(y, m, 0).getDate();
  const end = `${ym}-${lastDay}`;
  
  // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—ï¼ˆæ—¢ã«æœ€é©åŒ–æ¸ˆã¿ï¼‰
  const { data: books } = await db.from('bookings')
    .select('staff, fee, date')
    .gte('date', start)
    .lte('date', end)
    .neq('status', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  const list = books || [];
    
  // KPI
  const totalSales = list.reduce((sum, b) => sum + Number(b.fee || 0), 0);
  const count = list.length;
  const avg = count ? Math.round(totalSales / count) : 0;
  
  document.getElementById('kpiSales').textContent = 'Â¥' + totalSales.toLocaleString();
  document.getElementById('kpiCount').textContent = count + 'ä»¶';
  document.getElementById('kpiAvg').textContent = 'Â¥' + avg.toLocaleString();
  
  // List: Staff Stats
  const stStats = {}; STAFFS.forEach(s => stStats[s] = {c:0, s:0});
  list.forEach(b => { if(stStats[b.staff]) { stStats[b.staff].c++; stStats[b.staff].s += Number(b.fee||0); } });
  
  let stHtml = '';
  STAFFS.forEach(s => {
    stHtml += `
      <div class="staff-row">
        <div class="s-name">${s}</div>
        <div class="s-data"><span class="s-cnt">${stStats[s].c}ä»¶</span><span class="s-amt">Â¥${stStats[s].s.toLocaleString()}</span></div>
      </div>`;
  });
  document.getElementById('staffList').innerHTML = stHtml;

  // Chart: Cumulative
  const daysInMonth = lastDay;
  const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);
  const dailyData = new Array(daysInMonth).fill(0);
  
  list.forEach(b => {
    const day = parseInt(b.date.split('-')[2]) - 1;
    if(day >= 0 && day < daysInMonth) dailyData[day] += Number(b.fee || 0);
  });
  
  let acc = 0;
  const cumData = dailyData.map(v => { acc += v; return acc; });
  
  if(chartInst) chartInst.destroy();
  const ctx = document.getElementById('chartLine').getContext('2d');
  chartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'å£²ä¸Š (ç´¯ç©)', data: cumData,
        borderColor: '#111827', backgroundColor: 'rgba(17, 24, 39, 0.05)',
        tension: 0.3, fill: true, pointRadius: 2
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });

  showLoad(false);
}

// UTILS
function move(n) { s.date.setDate(s.date.getDate()+n); load(); }
function openMod(id) { document.querySelectorAll('.overlay').forEach(e=>e.classList.remove('open')); document.getElementById(id).classList.add('open'); }
function closeAll() { document.querySelectorAll('.overlay').forEach(e=>e.classList.remove('open')); }
function showLoad(b){ 
  const l = document.getElementById('loader');
  if(b) { l.style.display='flex'; setTimeout(()=>l.classList.add('show'),10); } else { l.classList.remove('show'); setTimeout(()=>l.style.display='none',300); }
}
function showToast(msg){
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 3000);
}
function fmtLocal(d) {
  const y = d.getFullYear();
  const m = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}
function addTime(t, m) { let [hh,mm]=t.split(':').map(Number); mm+=m; while(mm>=60){hh++;mm-=60;} return ('0'+hh).slice(-2)+':'+('0'+mm).slice(-2); }
</script>
</body>
</html>
