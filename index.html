<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>89CENTER</title>
  <!-- Supabase JS (UMD Build) & LIFF -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    /* 89CENTER DESIGN v12 (Same Style) */
    :root { --bg:#FFF; --text:#000; --sub:#999; --line:#E5E5E5; --accent:#000; --error:#FF3B30; --font:"Helvetica Neue",Arial,sans-serif; }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }
    body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family:var(--font); font-size:13px; letter-spacing:0.04em; -webkit-font-smoothing:antialiased; }
    .container { max-width:500px; margin:0 auto; padding:0 20px 100px; }
    header { height:80px; display:flex; align-items:center; justify-content:center; position:sticky; top:0; background:rgba(255,255,255,0.9); backdrop-filter:blur(10px); z-index:50; border-bottom:1px solid transparent; }
    h1 { font-size:14px; font-weight:700; letter-spacing:0.15em; margin:0; }
    
    /* NAV */
    .nav { display:flex; justify-content:space-between; align-items:center; margin:40px 0; padding:0 10px; }
    .nav-btn { width:40px; height:40px; border:1px solid var(--line); border-radius:50%; background:transparent; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
    .date-display { text-align:center; }
    .date-main { font-size:24px; font-weight:300; margin-bottom:4px; }
    .date-sub { font-size:11px; color:var(--sub); font-family:monospace; }
    #datePicker { position:absolute; opacity:0; pointer-events:none; }

    /* GRID */
    .grid-scroller { overflow-x:auto; margin:0 -20px; padding:0 20px; }
    table { width:100%; min-width:360px; border-collapse:collapse; table-layout:fixed; }
    th { font-size:10px; font-weight:700; color:var(--sub); padding:20px 0; border-bottom:1px solid var(--text); }
    th:first-child { position:sticky; left:0; z-index:20; width:48px; background:var(--bg); border-right:1px solid var(--line); }
    td { height:60px; border-bottom:1px solid var(--line); vertical-align:middle; position:relative; }
    td:first-child { position:sticky; left:0; z-index:5; background:var(--bg); border-right:1px solid var(--line); text-align:center; font-size:11px; font-weight:600; color:var(--sub); }
    
    .cell { width:100%; height:100%; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .free::after { content:''; width:6px; height:6px; border:1px solid var(--text); border-radius:50%; }
    .booked::after, .blocked::after, .closed::after { content:''; width:4px; height:1px; background:var(--line); }
    .own { background:var(--text); }
    .own::after { content:''; width:6px; height:6px; background:#fff; border-radius:50%; }

    /* MODAL */
    .overlay { position:fixed; inset:0; background:rgba(255,255,255,0.1); backdrop-filter:blur(8px); display:flex; align-items:flex-end; justify-content:center; z-index:100; opacity:0; pointer-events:none; transition:opacity 0.4s; }
    .overlay.open { opacity:1; pointer-events:auto; }
    .sheet { width:100%; max-width:500px; background:#fff; box-shadow:0 -10px 40px rgba(0,0,0,0.1); border-radius:32px 32px 0 0; padding:40px 32px 60px; transform:translateY(100%); transition:transform 0.4s cubic-bezier(0.16,1,0.3,1); }
    .overlay.open .sheet { transform:translateY(0); }
    
    .sheet-h { text-align:center; margin-bottom:40px; }
    .sheet-ttl { font-size:12px; font-weight:700; letter-spacing:0.2em; margin-bottom:8px; }
    .inp { width:100%; border:none; border-bottom:1px solid var(--text); padding:16px 0; font-size:16px; margin-bottom:24px; border-radius:0; }
    .btn-wrap { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:40px; }
    .btn { height:56px; border:1px solid var(--line); background:#fff; border-radius:4px; font-size:12px; font-weight:700; letter-spacing:0.1em; cursor:pointer; }
    .btn-bk { background:var(--text); color:#fff; border-color:var(--text); }
    .hidden { display:none; }
    
    /* LOADER */
    .loader { position:fixed; inset:0; background:#fff; z-index:999; display:flex; align-items:center; justify-content:center; transition:opacity 0.5s; }
    .line { width:40px; height:2px; background:var(--line); position:relative; overflow:hidden; }
    .line::after { content:''; position:absolute; inset:0; background:var(--text); transform:translateX(-100%); animation:load 1.5s cubic-bezier(0.8,0,0.2,1) infinite; }
    @keyframes load { 0% { transform:translateX(-100%); } 50% { transform:translateX(0); } 100% { transform:translateX(100%); } }
  </style>
</head>
<body>
  <div class="loader" id="loader"><div class="line"></div></div>
  <header><h1>89CENTER</h1></header>
  
  <div class="container">
    <div class="nav">
      <button class="nav-btn" onclick="addDay(-1)">−</button>
      <div class="date-display" onclick="document.getElementById('datePicker').showPicker()">
        <div class="date-main" id="dMain"></div><div class="date-sub" id="dSub"></div>
        <input type="date" id="datePicker">
      </div>
      <button class="nav-btn" onclick="addDay(1)">+</button>
    </div>
    <div class="grid-scroller">
      <table id="schedule"><thead id="thead"></thead><tbody id="tbody"></tbody></table>
    </div>
  </div>

  <div class="overlay" id="modal">
    <div class="sheet">
      <div class="sheet-h"><div class="sheet-ttl" id="mTitle"></div><div style="font-size:11px; color:#999;" id="mSub"></div></div>
      
      <div id="formCreate" class="hidden">
        <input class="inp" id="pName" placeholder="YOUR NAME">
        <input class="inp" id="pPhone" type="tel" placeholder="PHONE NUMBER">
        <input class="inp" id="pSym" placeholder="NOTE (OPTIONAL)">
        <div class="btn-wrap">
          <button class="btn" onclick="closeModal()">CLOSE</button>
          <button class="btn btn-bk" onclick="createBooking()">CONFIRM</button>
        </div>
      </div>

      <div id="formCancel" class="hidden">
        <div class="btn-wrap">
          <button class="btn" onclick="closeModal()">CLOSE</button>
          <button class="btn" style="color:#F00; border-color:#F00;" onclick="cancelBooking()">CANCEL</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ★ CONFIG: SUPABASE ★
const SUPABASE_URL = 'https://zzezehgnzeneueklxduy.supabase.co';
const SUPABASE_KEY = 'sb_publishable_J5lxwjP27PycJD78Jkgzsw_VhW4ThgJ';
const LIFF_ID = '2007980232-dK2Dp84Y';
const STAFFS = ['麻生川','岡野','堀江','松田','山口'];
const FEES = {'麻生川':16500,'岡野':11000,'堀江':11000,'松田':11000,'山口':11000};
const WEEKLY_OFF = { '麻生川':1, '松田':2, '堀江':4, '山口':5, '岡野':6 }; // 0=Sun

// Init Clients
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let state = { date: new Date(), uid: '', data: {}, pending: null };

window.onload = async () => {
  renderHead(); renderDate();
  document.getElementById('datePicker').onchange = (e) => {
    if(e.target.value) { state.date = new Date(e.target.value); renderDate(); loadData(); }
  };

  try {
    if (typeof liff !== 'undefined') {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        if (!liff.isInClient()) liff.login();
      } else {
        const p = await liff.getProfile(); state.uid = p.userId;
      }
    }
  } catch(e) { if(location.hostname.includes('localhost')) state.uid = 'DEBUG_USER'; }
  loadData();
};

async function loadData() {
  loading(true);
  const dStr = fmt(state.date);
  
  // 1. Get Bookings
  const { data: books } = await db.from('bookings').select('*').eq('date', dStr).neq('status', 'キャンセル');
  // 2. Get Blocks
  const { data: blocks } = await db.from('blocks').select('*').eq('date', dStr);
  
  // Logic
  const res = {};
  const slots = genSlots();
  const dow = state.date.getDay();

  STAFFS.forEach(s => {
    res[s] = {};
    slots.forEach(t => res[s][t] = { status:'free', id:'' });
    // Closed
    if(WEEKLY_OFF[s] === dow) slots.forEach(t => res[s][t].status = 'closed');
  });

  // Blocks
  if(blocks) blocks.forEach(b => {
    if(res[b.staff] && res[b.staff][b.time]) res[b.staff][b.time].status = 'blocked';
  });

  // Bookings
  if(books) books.forEach(b => {
    let t = b.start_time;
    // 簡易的に60分枠として処理
    const endSlots = [t, addTime(t, 30)];
    endSlots.forEach(slot => {
        if(res[b.staff] && res[b.staff][slot]) {
            res[b.staff][slot].status = (b.user_id === state.uid) ? 'own' : 'booked';
            res[b.staff][slot].id = b.id;
        }
    });
  });

  state.data = res;
  renderBody();
  loading(false);
}

async function createBooking() {
  const name = document.getElementById('pName').value;
  const phone = document.getElementById('pPhone').value;
  if(!name || !phone) return alert('入力してください');
  
  loading(true);
  const p = state.pending;
  
  // Conflict Check
  const { data: exists } = await db.from('bookings')
    .select('id').eq('date', fmt(state.date)).eq('staff', p.staff).eq('start_time', p.time).neq('status', 'キャンセル');
    
  if(exists && exists.length > 0) { loading(false); alert('既に予約が入っています'); return; }

  const id = Math.random().toString(36).substr(2, 9).toUpperCase();
  const end = addTime(p.time, 60);
  
  const { error } = await db.from('bookings').insert({
    id: id,
    date: fmt(state.date),
    start_time: p.time,
    end_time: end,
    staff: p.staff,
    patient_name: name,
    phone: phone,
    symptoms: document.getElementById('pSym').value,
    fee: FEES[p.staff],
    user_id: state.uid
  });

  if(error) alert('Error: ' + error.message);
  else { closeModal(); loadData(); alert('予約しました'); }
  loading(false);
}

async function cancelBooking() {
  loading(true);
  const { error } = await db.from('bookings')
    .update({ status: 'キャンセル' })
    .eq('id', state.pending.id)
    .eq('user_id', state.uid); // Security check
    
  if(error) alert('Error: ' + error.message);
  else { closeModal(); loadData(); alert('キャンセルしました'); }
  loading(false);
}

// --- UI HELPERS ---
function renderHead() {
  let h = '<tr><th></th>'; STAFFS.forEach(s => h += `<th>${s}</th>`);
  document.getElementById('thead').innerHTML = h + '</tr>';
}
function renderDate() {
  const d = state.date, w = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
  document.getElementById('dMain').textContent = `${d.getMonth()+1}.${d.getDate()}`;
  document.getElementById('dSub').textContent = w[d.getDay()];
  document.getElementById('datePicker').value = fmt(d);
}
function renderBody() {
  const b = document.getElementById('tbody'); b.innerHTML = '';
  const times = genSlots();
  times.forEach(t => {
    const tr = document.createElement('tr');
    let h = `<td>${t}</td>`;
    STAFFS.forEach(s => {
      const st = state.data[s][t].status;
      h += `<td><div class="cell ${st}" onclick="tap('${s}','${t}','${st}','${state.data[s][t].id}')"></div></td>`;
    });
    tr.innerHTML = h; b.appendChild(tr);
  });
}
function tap(s, t, st, id) {
  if(st==='blocked'||st==='closed'||st==='booked') return;
  state.pending = { staff:s, time:t, id:id };
  document.getElementById('mTitle').textContent = st==='own' ? 'YOUR BOOKING' : 'RESERVATION';
  document.getElementById('mSub').textContent = `${s} @ ${t}`;
  
  const isOwn = st==='own';
  document.getElementById('formCreate').classList.toggle('hidden', isOwn);
  document.getElementById('formCancel').classList.toggle('hidden', !isOwn);
  if(!isOwn) { document.getElementById('pName').value=''; document.getElementById('pPhone').value=''; }
  document.getElementById('modal').classList.add('open');
}
function closeModal() { document.getElementById('modal').classList.remove('open'); }
function addDay(n) { state.date.setDate(state.date.getDate()+n); renderDate(); loadData(); }
function loading(b) { const l=document.getElementById('loader'); l.style.opacity=b?'1':'0'; l.style.pointerEvents=b?'auto':'none'; }
function fmt(d) { return d.toISOString().split('T')[0]; }
function genSlots() { const a=[]; for(let h=9; h<21; h++) for(let m=0; m<60; m+=30) a.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2)); return a; }
function addTime(t, m) { let [hh,mm]=t.split(':').map(Number); mm+=m; while(mm>=60){hh++;mm-=60;} return ('0'+hh).slice(-2)+':'+('0'+mm).slice(-2); }
</script>
</body>
</html>
