<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>89CENTER</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <style>
    /* --- 89CENTER MOBILE DESIGN v28 (Strictly Fixed Width) --- */
    :root {
      --bg: #FFFFFF;
      --text: #222222;
      --sub: #666666;
      --line: #E0E0E0;
      --accent: #111111;
      --surface: #FAFAFA;
      
      /* Status Colors */
      --color-own: #BF360C;
      --bg-own: #FFE0B2;
      --color-ng: #999999;
      --bg-ng: #F7F7F7;
      
      --font-jp: "Noto Sans JP", sans-serif;
      --font-en: "Roboto", sans-serif;
      --radius: 8px;
      --ease: cubic-bezier(0.2, 0.9, 0.2, 1);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      font-family: var(--font-jp); font-size: 14px; line-height: 1.5;
      -webkit-font-smoothing: antialiased; padding-bottom: calc(80px + var(--safe-bottom));
    }

    /* UTILS */
    .en { font-family: var(--font-en); font-weight: 500; font-size: 0.75em; opacity: 0.5; margin-left: 2px; letter-spacing: 0.05em; text-transform: uppercase; }
    .hidden { display: none !important; }

    /* CONTAINER */
    .container { width: 100%; max-width: 600px; margin: 0 auto; padding: 0 12px; }

    /* HEADER */
    header {
      height: 64px; display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; background: rgba(255,255,255,0.96); backdrop-filter: blur(12px);
      z-index: 50; border-bottom: 1px solid transparent; transition: border-color 0.3s;
      padding: 0 16px; margin-bottom: 12px;
    }
    header.scrolled { border-color: var(--line); }
    h1 { font-family: var(--font-en); font-size: 18px; font-weight: 700; letter-spacing: 0.05em; margin: 0; }
    
    .header-btn {
      font-size: 10px; font-weight: 700; color: var(--text); border: 1px solid var(--line);
      padding: 4px 10px; border-radius: 99px; background: transparent; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; line-height: 1; gap: 2px;
    }

    /* NAV */
    .nav { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; padding: 0 4px; }
    .nav-btn {
      width: 44px; height: 44px; border: 1px solid var(--line); border-radius: 50%;
      background: #fff; color: var(--text); font-size: 20px; font-weight: 900; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex-shrink: 0;
    }
    .nav-btn:active { background: var(--text); color: #fff; transform: scale(0.95); }
    .nav-btn:disabled { opacity: 0.3; pointer-events: none; border-color: var(--line); box-shadow: none; }
    
    .date-display { 
      flex-grow: 1; margin: 0 12px;
      text-align: center; cursor: pointer; position: relative; 
      padding: 6px 0; border-radius: 12px; transition: background 0.2s;
    }
    .date-display:active { background: var(--surface); }
    .date-main { 
      font-size: 18px; font-weight: 700; font-feature-settings: "palt"; 
      display: flex; align-items: center; justify-content: center; gap: 8px; 
    }
    .date-sub { font-family: var(--font-en); font-size: 11px; color: var(--sub); letter-spacing: 0.05em; margin-top: 2px; }
    
    /* Calendar Button */
    .cal-btn {
      width: 24px; height: 24px; border-radius: 50%; background: var(--text); color: #fff;
      display: flex; align-items: center; justify-content: center; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .cal-icon { width: 12px; height: 12px; }
    #datePicker { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 10; }

    /* LEGEND (å‡¡ä¾‹) */
    .legend { 
      display: flex; justify-content: center; gap: 16px; margin-bottom: 20px; 
      font-size: 11px; color: var(--text); font-weight: 700;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    
    .mark { display: flex; align-items: center; justify-content: center; font-family: var(--font-en); }
    .mark.free { font-size: 18px; color: #444; line-height: 1; } /* â—‹ */
    .mark.own { width: 10px; height: 10px; background: var(--color-own); border-radius: 50%; box-shadow: 0 0 0 2px var(--bg-own); } /* â— */
    .mark.ng { font-size: 20px; color: var(--color-ng); line-height: 1; } /* Ã— */

    /* TABLE (Strictly Fixed Layout) */
    .grid-wrapper {
      position: relative; border-radius: 12px; overflow: hidden;
      border: 1px solid var(--line); box-shadow: 0 4px 20px rgba(0,0,0,0.02);
      width: 100%;
    }
    
    .grid-scroller { 
      width: 100%;
      overflow: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    }
    
    table { 
      width: 100%; 
      table-layout: fixed; /* åˆ—å¹…ã‚’å›ºå®š */
      border-collapse: separate; 
      border-spacing: 0; 
    }
    
    th {
      font-size: 11px; /* ã‚¹ã‚¿ãƒƒãƒ•åã‚’å¤§ãã */
      font-weight: 700; color: var(--text); text-align: center;
      padding: 12px 0; border-bottom: 2px solid var(--text);
      position: sticky; top: 0; z-index: 10; background: var(--bg);
      line-height: 1.2;
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }
    th .en { font-size: 8px; font-weight: 400; color: var(--sub); display: block; margin-top: 2px; transform: scale(0.85); margin-left: 0; }
    
    /* Time Column Width */
    th:first-child { 
      position: sticky; left: 0; z-index: 20; width: 34px; 
      border-right: 1px solid var(--line); 
    }

    td { height: 50px; vertical-align: middle; border-bottom: 1px solid var(--line); padding: 0; }
    td:first-child {
      position: sticky; left: 0; z-index: 5; background: var(--bg);
      border-right: 1px solid var(--line);
      text-align: center; font-family: var(--font-en); font-size: 10px; font-weight: 500; color: var(--sub);
    }

    /* CELLS */
    .cell {
      width: 100%; height: 100%; border-radius: 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; position: relative; transition: background 0.1s;
    }
    
    /* ç©ºã: â—‹ */
    .cell.free::after { 
      content: 'â—‹'; font-size: 14px; color: #333; /* æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
      font-weight: 400; line-height: 1;
      font-family: var(--font-en);
    }
    .cell.free:active { background-color: var(--surface); }
    
    /* NG: Ã— */
    .booked, .blocked, .closed, .past { cursor: default; background: var(--bg-ng); }
    .booked::after, .blocked::after, .closed::after, .past::after { 
      content: 'Ã—'; 
      font-family: sans-serif; 
      font-size: 18px; 
      color: #999; 
      font-weight: 400; 
      line-height: 1;
      margin-top: -2px;
    }
    .blocked::after { content: 'âˆ’'; font-size: 16px; font-weight: 700; }

    /* è‡ªåˆ†ã®äºˆç´„: â— */
    .own { 
      background: var(--bg-own); color: var(--color-own); 
      border: 1px solid rgba(230, 126, 34, 0.2);
    }
    .own::after { content: ''; } 

    /* FOOTER LINK */
    .footer-links { text-align: center; margin-top: 32px; padding-bottom: 20px; display: flex; flex-direction: column; gap: 12px; }
    .link { color: var(--text); text-decoration: underline; cursor: pointer; font-size: 11px; }
    .link-sub { color: var(--sub); font-size: 10px; text-decoration: none; }

    /* MODALS */
    .overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(6px);
      display: flex; align-items: flex-end; justify-content: center;
      z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s var(--ease);
    }
    .overlay.open { opacity: 1; pointer-events: auto; }
    
    .sheet {
      width: 100%; max-width: 600px; background: #fff;
      border-radius: 20px 20px 0 0; padding: 24px 20px calc(24px + var(--safe-bottom));
      transform: translateY(100%); transition: transform 0.4s var(--ease);
      max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
    }
    .overlay.open .sheet { transform: translateY(0); }

    .sheet-header { text-align: center; margin-bottom: 32px; }
    .sheet-title { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
    .sheet-sub { font-size: 10px; color: var(--sub); font-family: var(--font-en); letter-spacing: 0.1em; }

    .info-list { margin-bottom: 32px; border: 1px solid var(--line); border-radius: 12px; padding: 0 16px; }
    .info-item { display: flex; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--line); font-size: 13px; }
    .info-item:last-child { border-bottom: none; }
    .info-label { font-size: 11px; color: var(--sub); font-weight: 700; }
    .info-value { font-weight: 700; }

    .form-group { margin-bottom: 32px; }
    .inp { 
      width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--line); 
      border-radius: 8px; font-size: 15px; -webkit-appearance: none; background: #fff;
      transition: border-color 0.2s;
    }
    .inp:focus { outline: none; border-color: var(--text); }
    .inp::placeholder { color: #BBB; }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px; }
    .btn { 
      height: 48px; border: 1px solid var(--line); background: #fff; border-radius: 99px; 
      font-size: 13px; font-weight: 700; cursor: pointer; 
      display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1; 
      transition: opacity 0.2s;
    }
    .btn:active { opacity: 0.7; transform: scale(0.98); }
    .btn-primary { background: var(--text); color: #fff; border-color: var(--text); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
    .btn-danger { color: var(--error); border-color: rgba(255,59,48,0.3); background: rgba(255,59,48,0.05); }
    .btn-full { width: 100%; margin-top: 12px; }

    .chk-wrap { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; padding: 8px; border-radius: 8px; background: var(--surface); }
    .chk { width: 20px; height: 20px; accent-color: var(--text); margin: 0; flex-shrink: 0; }
    .chk-label { font-size: 12px; line-height: 1.5; color: var(--text); font-weight: 500; }
    .link { color: var(--text); text-decoration: underline; cursor: pointer; }

    /* STAFF LIST */
    .staff-list { display: grid; gap: 16px; }
    .staff-card { 
      border: 1px solid var(--line); border-radius: 12px; padding: 20px; 
      background: var(--surface); transition: all 0.2s;
    }
    .staff-card:hover { border-color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .staff-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .staff-name { font-size: 18px; font-weight: 700; color: var(--text); }
    .staff-role { 
      font-size: 11px; background: var(--text); color: #fff; 
      padding: 6px 12px; border-radius: 6px; font-weight: 700; 
      letter-spacing: 0.05em; text-transform: uppercase;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .staff-fee { 
      display: flex; align-items: baseline; gap: 4px; 
      margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--line);
    }
    .staff-fee-label { font-size: 11px; color: var(--sub); font-weight: 500; }
    .staff-fee-value { 
      font-size: 20px; font-weight: 800; color: var(--text); 
      font-family: var(--font-en); letter-spacing: 0.02em;
    }
    .staff-fee-unit { font-size: 12px; color: var(--sub); margin-left: 2px; }
    .staff-intro { font-size: 11px; text-align: center; color: var(--sub); margin-bottom: 20px; line-height: 1.7; background: var(--surface); padding: 12px; border-radius: 12px; }

    /* GUIDE & TERMS Styles */
    .modal-content-box { height: 360px; overflow-y: auto; padding-right: 4px; -webkit-overflow-scrolling: touch; }
    
    .guide-section { margin-bottom: 32px; }
    .guide-ttl { 
      font-size: 13px; font-weight: 700; color: var(--text); 
      margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
      padding-bottom: 8px; border-bottom: 1px solid var(--line);
    }
    
    .step-list { display: flex; flex-direction: column; gap: 16px; }
    .step-item { 
      display: flex; gap: 12px; align-items: flex-start; 
      background: var(--surface); padding: 16px; border-radius: 12px;
    }
    .step-num {
      background: var(--text); color: #fff; width: 24px; height: 24px; 
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; flex-shrink: 0; font-family: var(--font-en);
    }
    .step-content { flex-grow: 1; }
    .step-head { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
    .step-desc { font-size: 12px; color: var(--sub); line-height: 1.5; }

    .note-box {
      background: #FFF8E1; border: 1px solid #FFECB3; border-radius: 8px; padding: 12px;
      display: flex; gap: 10px; margin-top: 8px;
    }
    .note-icon { color: #F57F17; font-size: 16px; }
    .note-text { font-size: 11px; color: #5D4037; line-height: 1.6; }

    .terms-body { font-size: 12px; color: var(--sub); line-height: 1.8; }
    .terms-body h4 { color: var(--text); font-size: 13px; margin: 24px 0 8px; font-weight: 700; }
    .terms-body h4:first-child { margin-top: 0; }
    .terms-body p { margin: 0 0 12px; }
    .terms-body ul { padding-left: 1.5em; margin: 0 0 12px; }
    .terms-body li { margin-bottom: 4px; }

    /* WARNING MODAL */
    #warnModal .sheet { text-align: center; }
    .warn-icon { font-size: 32px; margin-bottom: 16px; display: block; }
    .warn-text { font-size: 16px; font-weight: 700; margin-bottom: 8px; }
    .warn-sub { font-size: 13px; color: var(--sub); line-height: 1.6; margin-bottom: 24px; }
    
    /* LOADER */
    .loader-overlay { position: fixed; inset: 0; background: #fff; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.4s; }
    .spinner { width: 40px; height: 40px; border-radius: 50%; border: 3px solid var(--line); border-top-color: var(--text); animation: spin 0.8s infinite linear; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .load-text { margin-top: 24px; font-family: var(--font-serif); font-size: 16px; letter-spacing: 0.2em; color: var(--text); font-weight: 700; }
    #loginOverlay { background: rgba(255,255,255,0.98); z-index: 2000; }
  </style>
</head>
<body>

  <div class="loader-overlay" id="loader"><div class="spinner"></div><div class="load-text">æœ¬æ°—ã§æ²»ã—ã¾ã™</div></div>

  <header id="header">
    <h1>89CENTER</h1>
    <button class="header-btn" onclick="openStaffModal()">
      æ–™é‡‘ã¨ã‚¹ã‚¿ãƒƒãƒ•ã«ã¤ã„ã¦<span class="en">FEES & STAFF</span>
    </button>
  </header>

  <div class="container">
    <div class="nav">
      <button class="nav-btn" id="prevBtn" onclick="addDay(-1)">â€¹</button>
      <div class="date-display" onclick="document.getElementById('datePicker').showPicker()">
        <div class="date-main" id="dMain">
          --æœˆ--æ—¥
          <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ -->
          <div class="cal-btn">
            <svg class="cal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </div>
        </div>
        <div class="date-sub" id="dSub">YYYY.MM.DD</div>
        <input type="date" id="datePicker">
      </div>
      <button class="nav-btn" id="nextBtn" onclick="addDay(1)">â€º</button>
    </div>

    <!-- ç›´æ„Ÿçš„ãªå‡¡ä¾‹ -->
    <div class="legend">
      <div class="legend-item"><span class="mark free">â—‹</span> ç©ºã</div>
      <div class="legend-item"><span class="mark own"></span> ã‚ãªãŸã®äºˆç´„</div>
      <div class="legend-item"><span class="mark ng">Ã—</span> äºˆç´„ä¸å¯</div>
    </div>

    <div class="grid-wrapper">
      <div class="grid-scroller">
        <table id="schedule">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer-links">
      <a class="link" onclick="openGuideModal()">äºˆç´„ã«ã¤ã„ã¦ã®æ³¨æ„äº‹é …ãƒ»ä½¿ã„æ–¹</a>
      <a class="link-sub" onclick="openTermsModal()">åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
    </div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="loginOverlay">
    <div style="text-align:center;">
      <h2 style="font-size:16px; margin-bottom:24px;">äºˆç´„ã«ã¯LINEãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
      <button class="btn btn-primary" style="width:200px;" onclick="liff.login()">LINEã§ãƒ­ã‚°ã‚¤ãƒ³<span class="en">LINE LOGIN</span></button>
    </div>
  </div>

  <div class="overlay" id="modal" onclick="if(event.target===this)closeAll()">
    <div class="sheet">
      <div class="sheet-header"><div class="sheet-title" id="mTitle">äºˆç´„ç¢ºèª</div><div class="sheet-sub" id="mSub">CONFIRMATION</div></div>
      <div class="info-list">
        <div class="info-item"><div class="info-label">æ—¥æ™‚</div><div class="info-value" id="mDate"></div></div>
        <div class="info-item"><div class="info-label">æ‹…å½“ã‚¹ã‚¿ãƒƒãƒ•</div><div class="info-value" id="mStaff"></div></div>
      </div>
      
      <!-- Create Form -->
      <div id="formCreate" class="hidden">
        <div class="form-group">
          <input class="inp" id="pName" placeholder="ãŠåå‰ (å¿…é ˆ)">
          <input class="inp" id="pPhone" type="tel" placeholder="é›»è©±ç•ªå· (å¿…é ˆã€ãƒã‚¤ãƒ•ãƒ³ãªã—)" maxlength="15" pattern="[0-9]*" inputmode="numeric">
          <input class="inp" id="pSym" placeholder="ç—‡çŠ¶ãƒ»ã”è¦æœ› (ä»»æ„)">
        </div>
        <div class="chk-wrap">
          <input type="checkbox" id="inTerm" class="chk">
          <label for="inTerm" class="chk-label"><span class="link" onclick="openTermsModal()">åˆ©ç”¨è¦ç´„</span> ã¨ <span class="link" onclick="openTermsModal()">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</span> ã«åŒæ„ã™ã‚‹</label>
        </div>
        <div class="btn-group">
          <button class="btn" onclick="closeAll()">é–‰ã˜ã‚‹<span class="en">CLOSE</span></button>
          <button class="btn btn-primary" onclick="createBooking()">äºˆç´„ã™ã‚‹<span class="en">BOOK</span></button>
        </div>
      </div>
      
      <!-- Cancel Form -->
      <div id="formCancel" class="hidden">
        <p style="text-align:center; font-size:13px; color:var(--sub); margin-bottom:32px;">ã“ã®äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="btn-group">
          <button class="btn" onclick="closeAll()">æˆ»ã‚‹<span class="en">BACK</span></button>
          <button class="btn btn-danger" onclick="cancelBooking()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Ÿè¡Œ<span class="en">EXECUTE</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- STAFF MODAL -->
  <div class="overlay" id="staffModal" onclick="if(event.target===this)closeAll()">
    <div class="sheet">
      <div class="sheet-header"><div class="sheet-title">æ–™é‡‘ã¨ã‚¹ã‚¿ãƒƒãƒ•ã«ã¤ã„ã¦</div><div class="sheet-sub">FEES & STAFF</div></div>
      <div class="staff-intro">å½“é™¢ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯å…¨å“¡ã€å›½å®¶è³‡æ ¼ã‚’ä¿æœ‰ã—ã¦ãŠã‚Šã€<br><strong>ã©ã®ã‚ˆã†ãªç—‡çŠ¶ãƒ»æ²»ç™‚ã«ã‚‚åŸºæœ¬çš„ã«å¯¾å¿œå¯èƒ½</strong>ã§ã™ã€‚<br>ä¸‹è¨˜ã¯ãã‚Œãã‚Œã®å¾—æ„åˆ†é‡ãƒ»å°‚é–€é ˜åŸŸã®ã”æ¡ˆå†…ã§ã™ã€‚</div>
      <div class="staff-list" id="staffListContainer">
        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
      </div>
      <button class="btn btn-full" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- GUIDE MODAL (æ³¨æ„äº‹é …ãƒ»ä½¿ã„æ–¹) -->
  <div class="overlay" id="guideModal" onclick="if(event.target===this)closeAll()">
    <div class="sheet">
      <div class="sheet-header"><div class="sheet-title">æ³¨æ„äº‹é …ãƒ»ä½¿ã„æ–¹</div><div class="sheet-sub">GUIDE</div></div>
      <div class="modal-content-box">
        
        <div class="guide-section">
          <div class="guide-ttl">âš ï¸ æ³¨æ„äº‹é …ãƒ»å…è²¬äº‹é …</div>
          <p class="guide-txt">
            1. <strong>äºˆç´„ã®ç¢ºå®šã«ã¤ã„ã¦</strong><br>
            æœ¬ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹äºˆç´„ã¯ã€æ ã‚’ç¢ºä¿ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€æ–½è¡“åŠ¹æœã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ€¥ç—…ã‚„å¤©ç½ç­‰ã«ã‚ˆã‚Šã€åº—èˆ—å´ã®åˆ¤æ–­ã§äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦ã„ãŸã ãå ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br><br>
            2. <strong>ã‚·ã‚¹ãƒ†ãƒ éšœå®³ã«ã¤ã„ã¦</strong><br>
            é€šä¿¡ç’°å¢ƒã®ä¸å…·åˆç­‰ã«ã‚ˆã‚Šäºˆç´„ãŒæ­£å¸¸ã«å®Œäº†ã—ãªã‹ã£ãŸå ´åˆã€å½“é™¢ã¯è²¬ä»»ã‚’è² ã„ã‹ã­ã¾ã™ã€‚äºˆç´„å®Œäº†ç”»é¢ãŒè¡¨ç¤ºã•ã‚ŒãŸã“ã¨ã‚’å¿…ãšã”ç¢ºèªãã ã•ã„ã€‚<br><br>
            3. <strong>åˆ©ç”¨åˆ¶é™</strong><br>
            ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„ç›´å‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒç¹°ã‚Šè¿”ã•ã‚Œã‚‹å ´åˆã€æœ¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆ©ç”¨ã‚’åˆ¶é™ã•ã›ã¦ã„ãŸã ãã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
          </p>
        </div>

        <div class="guide-section">
          <div class="guide-ttl">ğŸ“± ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹</div>
          <div class="step-list">
            <div class="step-item">
              <div class="step-num">1</div>
              <div class="step-content">
                <div class="step-head">å¸Œæœ›ã®æ—¥æ™‚ã‚’é¸ã¶</div>
                <div class="step-desc">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰æ—¥ä»˜ã‚’é¸ã³ã¾ã™ã€‚æ™‚é–“ã®æ¨ªã«ã€Œâ—‹ã€ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ ãŒäºˆç´„å¯èƒ½ã§ã™ã€‚</div>
              </div>
            </div>
            <div class="step-item">
              <div class="step-num">2</div>
              <div class="step-content">
                <div class="step-head">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦äºˆç´„</div>
                <div class="step-desc">å¸Œæœ›ã®æ ã‚’ã‚¿ãƒƒãƒ—ã—ã€ãŠåå‰ã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ã€Œäºˆç´„ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ç¢ºå®šã—ã¾ã™ã€‚</div>
              </div>
            </div>
            <div class="step-item">
              <div class="step-num">3</div>
              <div class="step-content">
                <div class="step-head">äºˆç´„ã®ç¢ºèªãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
                <div class="step-desc">äºˆç´„æ¸ˆã¿ã®æ ã¯ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã«ãªã‚Šã¾ã™ã€‚ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨å†…å®¹ã®ç¢ºèªã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒå¯èƒ½ã§ã™ã€‚</div>
                <div class="note-box">
                  <span class="note-icon">âš ï¸</span>
                  <span class="note-text">å½“æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã¯è¡Œãˆã¾ã›ã‚“ã€‚ãŠæ‰‹æ•°ã§ã™ãŒãŠé›»è©±ã«ã¦ã”é€£çµ¡ãã ã•ã„ã€‚</span>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
      <button class="btn btn-full" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- TERMS MODAL (Updated Content) -->
  <div class="overlay" id="termsModal" onclick="if(event.target===this)closeAll()">
    <div class="sheet">
      <div class="sheet-header"><div class="sheet-title">è¦ç´„ãƒ»ãƒãƒªã‚·ãƒ¼</div><div class="sheet-sub">TERMS & PRIVACY</div></div>
      <div class="modal-content-box">
        <div class="terms-body">
          <h4>ç¬¬1æ¡ï¼ˆé©ç”¨ç¯„å›²ï¼‰</h4>
          <p>æœ¬è¦ç´„ã¯ã€å½“æ²»ç™‚é™¢ï¼ˆä»¥ä¸‹ã€Œå½“é™¢ã€ï¼‰ãŒæä¾›ã™ã‚‹äºˆç´„ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚·ã‚¹ãƒ†ãƒ ã€ï¼‰ã®åˆ©ç”¨è€…å…¨ã¦ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚</p>

          <h4>ç¬¬2æ¡ï¼ˆäºˆç´„ã®æˆç«‹ï¼‰</h4>
          <p>äºˆç´„ã¯ã€åˆ©ç”¨è€…ãŒæœ¬ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§äºˆç´„æ‰‹ç¶šãã‚’å®Œäº†ã—ã€ã‚·ã‚¹ãƒ†ãƒ ç”»é¢ä¸Šã«äºˆç´„å®Œäº†ã®æ—¨ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ç‚¹ã§æˆç«‹ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚</p>

          <h4>ç¬¬3æ¡ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ï¼‰</h4>
          <ul>
            <li>äºˆç´„ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å¤‰æ›´ã¯ã€åŸå‰‡ã¨ã—ã¦æœ¬ã‚·ã‚¹ãƒ†ãƒ ä¸Šã§è¡Œã£ã¦ãã ã•ã„ã€‚</li>
            <li><strong>äºˆç´„å½“æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã€æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯è¡Œãˆã¾ã›ã‚“ã€‚</strong>å¿…ãšå½“é™¢ã¸ç›´æ¥ãŠé›»è©±ã«ã¦ã”é€£çµ¡ãã ã•ã„ã€‚</li>
            <li>ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚„ç›´å‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãŒåº¦é‡ãªã‚‹å ´åˆã€ä»¥å¾Œã®ã”äºˆç´„ã‚’ãŠæ–­ã‚Šã™ã‚‹å ´åˆãŒã”ã–ã„ã¾ã™ã€‚</li>
          </ul>

          <h4>ç¬¬4æ¡ï¼ˆæ–½è¡“ã®å—ç™‚æ‹’å¦ï¼‰</h4>
          <p>å½“é™¢ã¯ã€åˆ©ç”¨è€…ãŒä»¥ä¸‹ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹å ´åˆã€æ–½è¡“ã‚’ãŠæ–­ã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
          <ul>
            <li>é£²é…’çŠ¶æ…‹ã€ã¾ãŸã¯æ³¥é…”çŠ¶æ…‹ã«ã‚ã‚‹å ´åˆ</li>
            <li>ä»–ã®æ‚£è€…æ§˜ã‚„ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®è¿·æƒ‘è¡Œç‚ºã‚’è¡Œã£ãŸå ´åˆ</li>
            <li>ãã®ä»–ã€å½“é™¢ãŒæ–½è¡“ä¸é©å½“ã¨åˆ¤æ–­ã—ãŸå ´åˆ</li>
          </ul>

          <h4>ç¬¬5æ¡ï¼ˆå…è²¬äº‹é …ï¼‰</h4>
          <p>é€šä¿¡å›ç·šã®éšœå®³ã€ã‚·ã‚¹ãƒ†ãƒ ãƒˆãƒ©ãƒ–ãƒ«ã€å¤©ç½åœ°å¤‰ç­‰ã®ä¸å¯æŠ—åŠ›ã«ã‚ˆã‚Šã€äºˆç´„ãŒæˆç«‹ã—ãªã‹ã£ãŸå ´åˆã‚„äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå¤±ã—ãŸå ´åˆã€å½“é™¢ã¯ãã‚Œã«ã‚ˆã‚Šç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>

          <h4>ç¬¬6æ¡ï¼ˆå€‹äººæƒ…å ±ã®å–æ‰±ã„ï¼‰</h4>
          <p>å½“é™¢ã¯ã€æœ¬ã‚·ã‚¹ãƒ†ãƒ ã‚’é€šã˜ã¦å–å¾—ã—ãŸåˆ©ç”¨è€…ã®å€‹äººæƒ…å ±ï¼ˆæ°åã€é›»è©±ç•ªå·ã€LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€äºˆç´„å±¥æ­´ç­‰ï¼‰ã‚’ä»¥ä¸‹ã®ç›®çš„ã§ã®ã¿åˆ©ç”¨ã—ã€æ³•ä»¤ã«åŸºã¥ãå ´åˆã‚’é™¤ãã€ç¬¬ä¸‰è€…ã«æä¾›ã—ã¾ã›ã‚“ã€‚</p>
          <ul>
            <li>æ–½è¡“ã®äºˆç´„ç®¡ç†ãŠã‚ˆã³å®Ÿæ–½</li>
            <li>äºˆç´„ç¢ºèªã‚„ç·Šæ€¥æ™‚ã®ã”é€£çµ¡</li>
            <li>å½“é™¢ã®ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã®ãŸã‚ã®çµ±è¨ˆåˆ†æï¼ˆå€‹äººã‚’ç‰¹å®šã§ããªã„å½¢ã§ã®åˆ©ç”¨ï¼‰</li>
          </ul>
        </div>
      </div>
      <button class="btn btn-full" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- WARNING MODAL -->
  <div class="overlay" id="warnModal" onclick="if(event.target===this)closeAll()">
    <div class="sheet" style="text-align:center;">
      <span class="warn-icon" style="font-size:32px; display:block; margin-bottom:16px;">âš ï¸</span>
      <div class="warn-text" style="font-size:16px; font-weight:700; margin-bottom:8px;">å½“æ—¥ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸å¯</div>
      <div class="warn-sub" style="font-size:13px; color:var(--sub); line-height:1.6; margin-bottom:24px;">
        å½“æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è¡Œãˆã¾ã›ã‚“ã€‚<br>ãŠæ‰‹æ•°ã§ã™ãŒã€ãŠé›»è©±ã«ã¦ã”é€£çµ¡ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
      </div>
      <button class="btn btn-primary w-full" onclick="closeAll()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
// CONFIG
const SUPABASE_URL = 'https://zzezehgnzeneueklxduy.supabase.co';
const SUPABASE_KEY = 'sb_publishable_J5lxwjP27PycJD78Jkgzsw_VhW4ThgJ';
const LIFF_ID = '2007980232-dK2Dp84Y';
const STAFFS = ['éº»ç”Ÿå·','å²¡é‡','å €æ±Ÿ','æ¾ç”°','å±±å£'];
let FEES = {'éº»ç”Ÿå·':16500,'å²¡é‡':11000,'å €æ±Ÿ':11000,'æ¾ç”°':11000,'å±±å£':11000}; // å‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹
const WEEKLY_OFF = { 'éº»ç”Ÿå·':1, 'æ¾ç”°':2, 'å €æ±Ÿ':4, 'å±±å£':5, 'å²¡é‡':6 };
const MAX_MONTHS = 2; 

// Init
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let state = { date: new Date(), uid: '', data: {}, pending: null };

// æ–™é‡‘ã‚’DBã‹ã‚‰èª­ã¿è¾¼ã‚€
async function loadFees() {
  try {
    const { data, error } = await db.from('staffs').select('name, fee');
    if(!error && data && data.length > 0) {
      data.forEach(staff => {
        if(STAFFS.includes(staff.name)) {
          FEES[staff.name] = Number(staff.fee) || FEES[staff.name];
        }
      });
    } else {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
      const saved = localStorage.getItem('89admin_fees');
      if(saved) {
        try {
          const savedFees = JSON.parse(saved);
          STAFFS.forEach(staff => {
            if(savedFees[staff]) FEES[staff] = Number(savedFees[staff]);
          });
        } catch(e) {}
      }
    }
  } catch(e) {
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã‚€
    const saved = localStorage.getItem('89admin_fees');
    if(saved) {
      try {
        const savedFees = JSON.parse(saved);
        STAFFS.forEach(staff => {
          if(savedFees[staff]) FEES[staff] = Number(savedFees[staff]);
        });
      } catch(e) {}
    }
  }
}

window.onload = async () => {
  window.onscroll = () => document.getElementById('header').classList.toggle('scrolled', window.scrollY > 10);
  
  // æ–™é‡‘ã‚’èª­ã¿è¾¼ã‚€
  await loadFees();
  
  // Date Limits
  const today = new Date();
  const maxDate = new Date();
  maxDate.setMonth(maxDate.getMonth() + MAX_MONTHS);
  
  const dp = document.getElementById('datePicker');
  // Use fmt to set min/max for date input
  dp.min = fmt(today); 
  dp.max = fmt(maxDate);
  
  dp.onchange = (e) => { 
    if(e.target.value) { 
      const d = new Date(e.target.value);
      // Reset time components for date comparison
      const todayZero = new Date();
      todayZero.setHours(0,0,0,0);
      
      if(d < todayZero) { 
          alert('éå»ã®æ—¥ä»˜ã¯é¸æŠã§ãã¾ã›ã‚“'); 
          // Reset to today
          e.target.value = fmt(today);
          state.date = new Date();
          renderDate();
          loadData();
          return; 
      }

      if(d > maxDate) { 
          alert('2ãƒ¶æœˆå…ˆä»¥é™ã®äºˆç´„ã¯ã§ãã¾ã›ã‚“'); 
          e.target.value = fmt(today); // Reset
          state.date = new Date();
          renderDate();
          loadData();
          return; 
      }
      
      state.date = d; renderDate(); loadData(); 
    } 
  };

  renderHead(); renderDate();

  try {
    if (typeof liff !== 'undefined') {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        const p = await liff.getProfile(); state.uid = p.userId; loadData();
      } else {
        if(liff.isInClient()) liff.login(); 
        else { loading(false); document.getElementById('loginOverlay').classList.add('open'); }
      }
    }
  } catch(e) { if(location.hostname.includes('localhost')) { state.uid='DEBUG_USER'; loadData(); } }
};

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼‰
const CACHE_PREFIX = '89booking_';
const CACHE_EXPIRY = 5 * 60 * 1000; // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹

// ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç†ï¼ˆç„¡æ–™æ 50,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æœˆã‚’è¶…ãˆãªã„ã‚ˆã†ã«ï¼‰
const RATE_LIMIT_KEY = '89booking_rate_limit';
const MAX_REQUESTS_PER_HOUR = 100; // 1æ™‚é–“ã‚ãŸã‚Šã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
const MAX_REQUESTS_PER_DAY = 2000; // 1æ—¥ã‚ãŸã‚Šã®æœ€å¤§ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ï¼ˆæœˆé–“60,000ã‚’ä¸‹å›ã‚‹ã‚ˆã†ã«ï¼‰

function checkRateLimit() {
  try {
    const stored = localStorage.getItem(RATE_LIMIT_KEY);
    const now = Date.now();
    
    if (!stored) {
      // åˆå›ã‚¢ã‚¯ã‚»ã‚¹
      localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify({
        hour: { count: 1, resetAt: now + 60 * 60 * 1000 },
        day: { count: 1, resetAt: now + 24 * 60 * 60 * 1000 }
      }));
      return { allowed: true };
    }
    
    const limits = JSON.parse(stored);
    
    // æ™‚é–“åˆ¶é™ã®ãƒã‚§ãƒƒã‚¯
    if (now > limits.hour.resetAt) {
      limits.hour = { count: 1, resetAt: now + 60 * 60 * 1000 };
    } else {
      limits.hour.count++;
      if (limits.hour.count > MAX_REQUESTS_PER_HOUR) {
        return { 
          allowed: false, 
          message: 'ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚',
          retryAfter: Math.ceil((limits.hour.resetAt - now) / 1000 / 60) // åˆ†
        };
      }
    }
    
    // æ—¥æ¬¡åˆ¶é™ã®ãƒã‚§ãƒƒã‚¯
    if (now > limits.day.resetAt) {
      limits.day = { count: 1, resetAt: now + 24 * 60 * 60 * 1000 };
    } else {
      limits.day.count++;
      if (limits.day.count > MAX_REQUESTS_PER_DAY) {
        return { 
          allowed: false, 
          message: '1æ—¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æ˜æ—¥å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
          retryAfter: Math.ceil((limits.day.resetAt - now) / 1000 / 60 / 60) // æ™‚é–“
        };
      }
    }
    
    localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(limits));
    return { allowed: true };
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¨±å¯ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    return { allowed: true };
  }
}

// XSSå¯¾ç­–: HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
  if (text == null) return '';
  const div = document.createElement('div');
  div.textContent = String(text);
  return div.innerHTML;
}

function getCacheKey(dateStr) {
  return CACHE_PREFIX + dateStr;
}

function getCachedData(dateStr) {
  try {
    const cached = localStorage.getItem(getCacheKey(dateStr));
    if (!cached) return null;
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp > CACHE_EXPIRY) {
      localStorage.removeItem(getCacheKey(dateStr));
      return null;
    }
    return data;
  } catch (e) {
    return null;
  }
}

function setCachedData(dateStr, data) {
  try {
    localStorage.setItem(getCacheKey(dateStr), JSON.stringify({
      data,
      timestamp: Date.now()
    }));
  } catch (e) {
    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡è¶…éæ™‚ã¯ç„¡è¦–
  }
}

function clearCache() {
  try {
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith(CACHE_PREFIX)) {
        localStorage.removeItem(key);
      }
    });
  } catch (e) {}
}

async function loadData() {
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const rateLimit = checkRateLimit();
  if (!rateLimit.allowed) {
    alert(rateLimit.message);
    return;
  }
  
  loading(true);
  const dStr = fmt(state.date);
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã¯å¸¸ã«æœ€æ–°ã‚’å–å¾—ï¼‰
  const now = new Date();
  const isToday = dStr === fmt(now);
  if (!isToday) {
    const cached = getCachedData(dStr);
    if (cached) {
      state.data = cached;
      renderBody();
      loading(false);
      return;
    }
  }
  
  // å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿å–å¾—ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  const { data: books } = await db.from('bookings')
    .select('id, start_time, end_time, staff, user_id')
    .eq('date', dStr)
    .neq('status', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  const { data: blocks } = await db.from('blocks')
    .select('staff, time')
    .eq('date', dStr);
  
  const res = {}; const slots = genSlots(); const dow = state.date.getDay();
  const isTodayCheck = dStr === fmt(now);

  STAFFS.forEach(s => {
    res[s] = {}; 
    slots.forEach(t => {
      let st = 'free';
      // Past time logic
      if (isTodayCheck) {
        const [h, m] = t.split(':');
        const timeDate = new Date(); timeDate.setHours(h, m, 0, 0);
        if (timeDate < now) st = 'past';
      }
      res[s][t] = { status: st, id:'' };
    });
    if(WEEKLY_OFF[s] === dow) slots.forEach(t => res[s][t].status = 'closed');
  });

  if(blocks) blocks.forEach(b => { if(res[b.staff]) res[b.staff][b.time].status = 'blocked'; });
  if(books) books.forEach(b => {
    // end_timeã‹ã‚‰é–‹å§‹æ™‚é–“ã¾ã§ã®æ™‚é–“å·®ã‚’è¨ˆç®—ã—ã¦ã€å¿…è¦ãªã‚»ãƒ«æ•°ã‚’ãƒ–ãƒ­ãƒƒã‚¯
    const startTime = b.start_time;
    const endTime = b.end_time;
    const bookingSlots = getTimeSlots(startTime, endTime);
    bookingSlots.forEach(slot => {
      if(res[b.staff] && res[b.staff][slot]) {
        res[b.staff][slot].status = (b.user_id === state.uid) ? 'own' : 'booked';
        res[b.staff][slot].id = b.id;
      }
    });
  });

  state.data = res;
  // ä»Šæ—¥ä»¥å¤–ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  if (!isTodayCheck) {
    setCachedData(dStr, res);
  }
  renderBody(); loading(false);
}

// é›»è©±ç•ªå·ã®æ¤œè¨¼
function validatePhone(phone) {
  if (!phone) return { valid: false, message: 'é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„' };
  // æ•°å­—ã®ã¿ã€10-15æ¡
  const phoneRegex = /^[0-9]{10,15}$/;
  if (!phoneRegex.test(phone)) {
    return { valid: false, message: 'é›»è©±ç•ªå·ã¯æ•°å­—ã®ã¿10-15æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰' };
  }
  return { valid: true };
}

async function createBooking() {
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const rateLimit = checkRateLimit();
  if (!rateLimit.allowed) {
    alert(rateLimit.message);
    return;
  }
  
  const name = document.getElementById('pName').value.trim();
  const phone = document.getElementById('pPhone').value.replace(/[^0-9]/g, ''); // æ•°å­—ã®ã¿æŠ½å‡º
  const term = document.getElementById('inTerm').checked;

  if(!name || !phone) return alert('ãŠåå‰ã¨é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  
  // é›»è©±ç•ªå·ã®æ¤œè¨¼
  const phoneValidation = validatePhone(phone);
  if (!phoneValidation.valid) {
    return alert(phoneValidation.message);
  }
  
  // åå‰ã®é•·ã•ãƒã‚§ãƒƒã‚¯
  if (name.length > 50) {
    return alert('ãŠåå‰ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  if(!term) return alert('åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®åŒæ„ãŒå¿…è¦ã§ã™');
  
  loading(true);
  const p = state.pending;

  // Validate Date Range
  const maxDate = new Date(); maxDate.setMonth(maxDate.getMonth() + MAX_MONTHS);
  if(state.date > maxDate) { loading(false); return alert('äºˆç´„æœŸé–“å¤–ã§ã™'); }
  
  // Validate Past Time
  if(isPast(state.date, p.time)) { loading(false); return alert('éå»ã®æ™‚é–“ã¯äºˆç´„ã§ãã¾ã›ã‚“'); }

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”»é¢ã¯60åˆ†å›ºå®š
  const duration = 60;
  const endTime = addTime(p.time, duration);
  const dStr = fmt(state.date);
  
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯: é¸æŠã—ãŸæ™‚é–“å¸¯ã«æ—¢å­˜ã®äºˆç´„ãŒãªã„ã‹ç¢ºèª
  const requiredSlots = getTimeSlots(p.time, endTime);
  
  // è©²å½“æ—¥ä»˜ã®æ—¢å­˜äºˆç´„ã‚’å–å¾—
  const { data: existingBookings } = await db.from('bookings')
    .select('id, start_time, end_time, staff, patient_name')
    .eq('date', dStr)
    .eq('staff', p.staff)
    .neq('status', 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
  
  // å„ã‚¹ãƒ­ãƒƒãƒˆãŒæ—¢å­˜äºˆç´„ã¨é‡è¤‡ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  if(existingBookings && existingBookings.length > 0) {
    for(const slot of requiredSlots) {
      for(const booking of existingBookings) {
        const bookingSlots = getTimeSlots(booking.start_time, booking.end_time);
        if(bookingSlots.includes(slot)) {
          loading(false);
          alert(`ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚é¸æŠã—ãŸæ™‚é–“å¸¯ï¼ˆ${p.time}ã€œ${endTime}ï¼‰ã¯æ—¢ã«äºˆç´„ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚åˆ¥ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚`);
          return;
        }
      }
    }
  }

  const id = Math.random().toString(36).substr(2, 9).toUpperCase();
  const { error } = await db.from('bookings').insert({
    id: id, date: dStr, start_time: p.time, end_time: endTime,
    staff: p.staff, patient_name: name, phone: phone, symptoms: document.getElementById('pSym').value,
    fee: FEES[p.staff], user_id: state.uid
  });

  if(error) alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message); 
  else { 
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    clearCache();
    closeAll(); 
    loadData(); 
    alert('äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼'); 
  }
  loading(false);
}

async function cancelBooking() {
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
  const rateLimit = checkRateLimit();
  if (!rateLimit.allowed) {
    alert(rateLimit.message);
    return;
  }
  
  // å½“æ—¥ãƒã‚§ãƒƒã‚¯
  const now = new Date();
  const targetDate = new Date(state.date); // è¡¨ç¤ºä¸­ã®æ—¥ä»˜
  
  if (fmt(now) === fmt(targetDate)) {
    closeAll();
    document.getElementById('warnModal').classList.add('open');
    return;
  }

  loading(true);
  const { error } = await db.from('bookings').update({ status: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«' }).eq('id', state.pending.id).eq('user_id', state.uid);
  if(error) alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message); 
  else { 
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    clearCache();
    closeAll(); 
    loadData(); 
    alert('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ'); 
  }
  loading(false);
}

// UI
function renderHead() {
  let h='<tr><th></th>'; STAFFS.forEach(s=>h+=`<th>${escapeHtml(s)}<span class="en">${escapeHtml(getEn(s))}</span></th>`); 
  document.getElementById('thead').innerHTML = h+'</tr>';
}
function getEn(n){ const m={'éº»ç”Ÿå·':'ASOGAWA','å²¡é‡':'OKANO','å €æ±Ÿ':'HORIE','æ¾ç”°':'MATSUDA','å±±å£':'YAMAGUCHI'}; return m[n]||''; }

function renderDate() {
  const d = state.date, w = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  document.getElementById('dMain').innerHTML = `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ (${w[d.getDay()]}) <div class="cal-btn"><svg class="cal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div>`;
  document.getElementById('dSub').textContent = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())}`;
  document.getElementById('datePicker').value = fmt(d);
  
  const today = new Date(); today.setHours(0,0,0,0);
  const max = new Date(); max.setMonth(max.getMonth() + MAX_MONTHS);
  
  const cur = new Date(d); cur.setHours(0,0,0,0);
  
  document.getElementById('prevBtn').disabled = (cur <= today);
  document.getElementById('nextBtn').disabled = (cur >= max);
}

function renderBody() {
  const b=document.getElementById('tbody'); b.innerHTML='';
  genSlots().forEach(t => {
    const tr=document.createElement('tr'); let h=`<td>${escapeHtml(t)}</td>`;
    STAFFS.forEach(s => {
      const st=state.data[s][t].status;
      const id = state.data[s][t].id || '';
      // XSSå¯¾ç­–: ã™ã¹ã¦ã®å€¤ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
      const escapedStaff = escapeHtml(s);
      const escapedTime = escapeHtml(t);
      const escapedStatus = escapeHtml(st);
      const escapedId = escapeHtml(id);
      h+=`<td><div class="cell ${escapedStatus}" onclick="tap('${escapedStaff}','${escapedTime}','${escapedStatus}','${escapedId}')"></div></td>`;
    });
    tr.innerHTML=h; b.appendChild(tr);
  });
}

function tap(s, t, st, id) {
  if(['blocked','closed','booked','past'].includes(st)) return;
  state.pending = { staff:s, time:t, id:id };
  document.getElementById('mTitle').textContent = st==='own' ? 'ã”äºˆç´„å†…å®¹' : 'äºˆç´„ç¢ºèª';
  document.getElementById('mSub').textContent = st==='own' ? 'YOUR BOOKING' : 'CONFIRMATION';
  // XSSå¯¾ç­–: textContentã‚’ä½¿ç”¨ï¼ˆæ—¢ã«å®‰å…¨ï¼‰
  document.getElementById('mDate').textContent = `${document.getElementById('dMain').textContent} ${t}`;
  document.getElementById('mStaff').textContent = s;
  
  const isOwn = st==='own';
  document.getElementById('formCreate').classList.toggle('hidden', isOwn);
  document.getElementById('formCancel').classList.toggle('hidden', !isOwn);
  if(!isOwn) { 
    document.getElementById('pName').value=''; document.getElementById('pPhone').value='';
    document.getElementById('pSym').value=''; document.getElementById('inTerm').checked = false;
  }
  document.getElementById('modal').classList.add('open');
}

function addDay(n) {
  const next = new Date(state.date); next.setDate(next.getDate()+n);
  const today = new Date(); today.setHours(0,0,0,0);
  const max = new Date(); max.setMonth(max.getMonth() + MAX_MONTHS);
  if(next < today || next > max) return;
  state.date = next; 
  renderDate(); 
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°å³åº§ã«è¡¨ç¤ºã€ãªã‘ã‚Œã°DBã‹ã‚‰å–å¾—
  loadData();
}

// ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ã®å®šç¾©
const STAFF_ROLES = {
  'éº»ç”Ÿå·': 'é ­ç—›å°‚é–€',
  'å²¡é‡': 'è†å°‚é–€',
  'å €æ±Ÿ': 'è€³é³´ã‚Šå°‚é–€',
  'æ¾ç”°': 'äº”åè‚©å°‚é–€',
  'å±±å£': 'ã—ã³ã‚Œå°‚é–€'
};

function renderStaffList() {
  const container = document.getElementById('staffListContainer');
  if (!container) return;
  
  container.innerHTML = '';
  STAFFS.forEach(staff => {
    const role = STAFF_ROLES[staff] || '';
    const fee = FEES[staff] || 0;
    // XSSå¯¾ç­–: ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    const escapedStaff = escapeHtml(staff);
    const escapedRole = escapeHtml(role);
    const escapedFee = fee.toLocaleString(); // æ•°å€¤ãªã®ã§ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ä¸è¦
    
    container.innerHTML += `
      <div class="staff-card">
        <div class="staff-header">
          <div class="staff-name">${escapedStaff}</div>
          <span class="staff-role">${escapedRole}</span>
        </div>
        <div class="staff-fee">
          <span class="staff-fee-label">æ–™é‡‘</span>
          <span class="staff-fee-value">Â¥${escapedFee}</span>
          <span class="staff-fee-unit">/ 1æ™‚é–“</span>
        </div>
      </div>
    `;
  });
}

function openStaffModal(){ 
  renderStaffList(); // æ–™é‡‘ã‚’æœ€æ–°ã®çŠ¶æ…‹ã§è¡¨ç¤º
  document.getElementById('staffModal').classList.add('open'); 
}
function openGuideModal(){ document.getElementById('guideModal').classList.add('open'); }
function openTermsModal(){ document.getElementById('termsModal').classList.add('open'); }
function closeAll(){ document.querySelectorAll('.overlay').forEach(e=>e.classList.remove('open')); }
function loading(b){ const l=document.getElementById('loader'); if(b){l.style.display='flex';setTimeout(()=>l.style.opacity=1,10);}else{l.style.opacity=0;setTimeout(()=>l.style.display='none',400);} }

function fmt(d) { 
  const y = d.getFullYear();
  const m = ('0' + (d.getMonth() + 1)).slice(-2);
  const day = ('0' + d.getDate()).slice(-2);
  return `${y}-${m}-${day}`;
}
function pad(n) { return ('0'+n).slice(-2); }
function genSlots() { const a=[]; for(let h=9;h<21;h++) for(let m=0;m<60;m+=30) a.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2)); return a; }
function addTime(t, m) { let [hh,mm]=t.split(':').map(Number); mm+=m; while(mm>=60){hh++;mm-=60;} return ('0'+hh).slice(-2)+':'+('0'+mm).slice(-2); }

// é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‹ã‚‰ã€30åˆ†åˆ»ã¿ã®ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—ã‚’å–å¾—
function getTimeSlots(startTime, endTime) {
  const slots = [];
  let current = startTime;
  while(current < endTime) {
    slots.push(current);
    current = addTime(current, 30);
  }
  return slots;
}

function isPast(d, t) {
  const now = new Date();
  const target = new Date(d);
  const [h,m] = t.split(':');
  target.setHours(h,m,0,0);
  return target < now;
}
</script>
</body>
</html>
