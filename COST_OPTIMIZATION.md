# コスト削減対策まとめ

## 📊 コストが発生する箇所と対策

### 1. データベース利用料（Supabase）

#### ❌ 問題点
- **頻繁なクエリ**: 日付変更のたびにDBから全データを取得
- **不要なデータ取得**: `select('*')`で全カラムを取得
- **リアルタイム更新**: メモ更新時に毎回UPDATEクエリ

#### ✅ 対策実装済み

##### 1.1 クエリ最適化
- **変更前**: `select('*')` - 全カラム取得
- **変更後**: 必要なカラムのみ指定
  ```javascript
  // index.html
  .select('id, start_time, staff, user_id')
  
  // admin.html
  .select('id, start_time, staff, patient_name, admin_memo')
  ```
- **効果**: データ転送量を約50-70%削減

##### 1.2 ローカルストレージキャッシュ
- **実装内容**:
  - 日付ごとのデータを5分間キャッシュ（index.html）
  - 管理画面は3分間キャッシュ（admin.html）
  - 今日の日付は常に最新データを取得
- **効果**: 同じ日付を再表示する際、DBクエリをスキップ

##### 1.3 デバウンス処理
- **実装内容**: メモ更新時に1秒待ってから保存
- **効果**: 連続入力時の不要なUPDATEクエリを削減

##### 1.4 キャッシュ無効化
- 予約作成・キャンセル・ブロック操作時に自動的にキャッシュをクリア
- 常に最新データを表示

### 2. サーバー利用料

#### ✅ 対策実装済み

##### 2.1 静的ホスティング（GitHub Pages）
- **設定ファイル**: `.github/workflows/deploy.yml`
- **効果**: サーバーコストが**完全に無料**
- **デプロイ方法**:
  1. GitHubリポジトリのSettings > Pages
  2. Source: "GitHub Actions"を選択
  3. `main`ブランチにプッシュすると自動デプロイ

## 📈 期待される効果

### データベース利用料
- **クエリ回数**: 約60-80%削減（キャッシュ効果）
- **データ転送量**: 約50-70%削減（必要なカラムのみ取得）
- **Supabase無料プラン**: 月間50,000リクエスト以内なら**完全無料**

### サーバー利用料
- **GitHub Pages**: **完全無料**（制限なし）
- **従来のサーバー**: 月額費用が不要

## 🔍 コスト監視のポイント

### Supabaseダッシュボードで確認すべき項目
1. **API Requests**: 月間リクエスト数（無料プラン: 50,000まで）
2. **Database Size**: データベース容量（無料プラン: 500MBまで）
3. **Bandwidth**: データ転送量（無料プラン: 5GBまで）

### コストが跳ねる可能性がある場合
1. **大量の予約データ**: 古いデータのアーカイブを検討
2. **頻繁な検索**: 検索結果もキャッシュ化を検討
3. **リアルタイム更新**: 必要に応じてポーリング間隔を調整

## 🛠️ 追加の最適化案（必要に応じて）

### 1. データアーカイブ
```sql
-- 3ヶ月以上前のキャンセル済み予約をアーカイブテーブルに移動
```

### 2. インデックス最適化
```sql
-- 既存のインデックスを確認
CREATE INDEX IF NOT EXISTS idx_bookings_date_status 
ON bookings(date, status) WHERE status != 'キャンセル';
```

### 3. バッチ処理
- メモ更新をまとめて保存（現在はデバウンス処理済み）

## 📝 注意事項

1. **キャッシュの有効期限**: 5分（index.html）、3分（admin.html）
2. **今日の日付**: 常に最新データを取得（キャッシュしない）
3. **データ更新時**: 自動的にキャッシュをクリア

## 🚀 デプロイ手順

1. 変更をコミット
   ```bash
   git add .
   git commit -m "コスト最適化: クエリ最適化とキャッシュ実装"
   git push origin main
   ```

2. GitHub Pagesの設定
   - Settings > Pages > Source: "GitHub Actions"
   - 自動的にデプロイが開始されます

3. 動作確認
   - ブラウザの開発者ツール > Networkタブでリクエスト数を確認
   - 同じ日付を再表示した際、キャッシュが効いているか確認
